# Step 3.1: Set Up Supabase Auth

**Part of:** PR 1.3 - Authentication Implementation  
**Focus:** Configure Supabase Authentication with email/password  
**Estimated Time:** 15 minutes

## Overview

Enable and configure Supabase Auth for user signup, login, and session management. This provides the foundation for personalized experiences and session tracking.

## Pre-Step Checklist

- [ ] **Completed:** PR 1.2 - Supabase setup complete
- [ ] **Access:** Supabase Dashboard Authentication settings
- [ ] **Installed:** `@supabase/ssr` package (from Step 2.2)

## Implementation

### Goal

Configure authentication providers and create reusable auth utilities.

### Step-by-Step Instructions

#### Step 1: Configure Auth in Supabase Dashboard

1. Open Supabase Dashboard → **Authentication** → **Providers**
2. Enable **Email** provider:
   - Toggle **"Enable Email provider"** to ON
   - **Confirm email:** Toggle ON (recommended for production)
   - **Secure email change:** Toggle ON
   - **Secure password change:** Toggle ON
3. Configure **Email Templates** (optional):
   - Go to **Authentication** → **Email Templates**
   - Customize **Confirm signup**, **Magic Link**, **Reset password** templates
   - Add DiveBuddy branding and links

#### Step 2: Update Environment Variables

Add to `.env.local`:

```bash
# Already have these from PR 1.2
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# Site URL for auth redirects
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

Add to `.env.example`:

```bash
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

#### Step 3: Create Auth Context

Create `src/lib/auth/auth-context.tsx`:

```typescript
'use client'

import { createContext, useContext, useEffect, useState } from 'react'
import { User, Session } from '@supabase/supabase-js'
import { createClient } from '@/lib/supabase/client'

interface AuthContextType {
  user: User | null
  session: Session | null
  loading: boolean
  signUp: (email: string, password: string, metadata?: any) => Promise<{ error: any }>
  signIn: (email: string, password: string) => Promise<{ error: any }>
  signOut: () => Promise<void>
  resetPassword: (email: string) => Promise<{ error: any }>
  updateProfile: (data: any) => Promise<{ error: any }>
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [session, setSession] = useState<Session | null>(null)
  const [loading, setLoading] = useState(true)
  const supabase = createClient()

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session)
      setUser(session?.user ?? null)
      setLoading(false)
    })

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session)
      setUser(session?.user ?? null)
      setLoading(false)
    })

    return () => subscription.unsubscribe()
  }, [supabase])

  const signUp = async (email: string, password: string, metadata?: any) => {
    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: metadata,
        emailRedirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/auth/callback`,
      },
    })
    return { error }
  }

  const signIn = async (email: string, password: string) => {
    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    })
    return { error }
  }

  const signOut = async () => {
    await supabase.auth.signOut()
  }

  const resetPassword = async (email: string) => {
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/auth/reset-password`,
    })
    return { error }
  }

  const updateProfile = async (data: any) => {
    const { error } = await supabase.auth.updateUser({
      data,
    })
    return { error }
  }

  return (
    <AuthContext.Provider
      value={{
        user,
        session,
        loading,
        signUp,
        signIn,
        signOut,
        resetPassword,
        updateProfile,
      }}
    >
      {children}
    </AuthContext.Provider>
  )
}

export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}
```

#### Step 4: Wrap App with Auth Provider

Update `src/app/layout.tsx`:

```typescript
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'
import { AuthProvider } from '@/lib/auth/auth-context'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'DiveBuddy - Your AI Diving Companion',
  description: 'Learn diving and plan your next underwater adventure with AI assistance',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <AuthProvider>
          {children}
        </AuthProvider>
      </body>
    </html>
  )
}
```

#### Step 5: Create Auth Callback Route

Create `src/app/auth/callback/route.ts`:

```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const requestUrl = new URL(request.url)
  const code = requestUrl.searchParams.get('code')
  const next = requestUrl.searchParams.get('next') || '/'

  if (code) {
    const supabase = createClient()
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    
    if (!error) {
      return NextResponse.redirect(new URL(next, request.url))
    }
  }

  // If auth failed, redirect to error page
  return NextResponse.redirect(new URL('/auth/error', request.url))
}
```

#### Step 6: Create Protected Route Utility

Create `src/lib/auth/protected-route.tsx`:

```typescript
'use client'

import { useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from './auth-context'

export function withAuth<P extends object>(
  Component: React.ComponentType<P>
) {
  return function ProtectedRoute(props: P) {
    const { user, loading } = useAuth()
    const router = useRouter()

    useEffect(() => {
      if (!loading && !user) {
        router.push('/auth/login?redirect=' + window.location.pathname)
      }
    }, [user, loading, router])

    if (loading) {
      return (
        <div className="flex items-center justify-center min-h-screen">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
      )
    }

    if (!user) {
      return null
    }

    return <Component {...props} />
  }
}
```

#### Step 7: Create Server-Side Auth Helper

Create `src/lib/auth/get-user.ts`:

```typescript
import { createClient } from '@/lib/supabase/server'
import { cache } from 'react'

export const getCurrentUser = cache(async () => {
  const supabase = createClient()
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser()

  if (error) {
    console.error('Error fetching user:', error)
    return null
  }

  return user
})

export const requireAuth = cache(async () => {
  const user = await getCurrentUser()
  
  if (!user) {
    throw new Error('Unauthorized')
  }

  return user
})
```

## Verification Checklist

- [ ] Email provider enabled in Supabase Dashboard
- [ ] `NEXT_PUBLIC_SITE_URL` added to `.env.local`
- [ ] `AuthProvider` created and wraps app layout
- [ ] Auth callback route created
- [ ] Protected route HOC created
- [ ] Server-side auth helpers created
- [ ] No TypeScript errors

## Testing

Test auth configuration:

```typescript
// In browser console or test component
import { createClient } from '@/lib/supabase/client'

const supabase = createClient()

// Test signup
await supabase.auth.signUp({
  email: 'test@example.com',
  password: 'SecurePassword123!'
})

// Check session
const { data } = await supabase.auth.getSession()
console.log(data.session)
```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Email not sent | Check Supabase → Settings → Auth → SMTP settings |
| Redirect loop | Verify `NEXT_PUBLIC_SITE_URL` matches actual URL |
| Session not persisting | Check cookies are enabled in browser |
| TypeScript errors | Run `npm install` and restart TypeScript server |
| User not appearing | Check RLS policies on `profiles` table |

## Security Considerations

### Password Requirements

Configure in Supabase Dashboard → Authentication → Policies:

- **Minimum password length:** 8 characters
- **Require uppercase:** Recommended
- **Require lowercase:** Recommended
- **Require numbers:** Recommended
- **Require special characters:** Optional

### Rate Limiting

Supabase automatically rate-limits auth endpoints:
- **Email signup:** 10 requests/hour per IP
- **Login:** 30 requests/hour per IP
- **Password reset:** 6 requests/hour per email

## Files Created

- ✅ Created: `src/lib/auth/auth-context.tsx` - React Context for auth state
- ✅ Created: `src/lib/auth/protected-route.tsx` - HOC for protected pages
- ✅ Created: `src/lib/auth/get-user.ts` - Server-side auth helpers
- ✅ Created: `src/app/auth/callback/route.ts` - OAuth callback handler
- ✅ Modified: `src/app/layout.tsx` - Wrapped with AuthProvider

## What Comes Next

**Step 3.2:** Create login and signup UI components

You now have:
- Email/password authentication configured
- React Context for client-side auth state
- Server-side auth utilities
- Protected route patterns
