# Step 3.3 & 3.4: Profile Page & Auth Middleware

**Part of:** PR 1.3 - Authentication Implementation  
**Focus:** User profile management and middleware protection  
**Estimated Time:** 20 minutes

## Overview

Create user profile page and implement middleware to protect routes.

## Implementation

### Step 1: Create Profile Page

Create `src/app/profile/page.tsx`:

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '@/lib/auth/auth-context'
import { createClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

interface Profile {
  full_name: string
  certification_level: string
  total_dives: number
}

export default function ProfilePage() {
  const { user, signOut } = useAuth()
  const router = useRouter()
  const [profile, setProfile] = useState<Profile | null>(null)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)

  useEffect(() => {
    if (!user) {
      router.push('/auth/login')
      return
    }
    loadProfile()
  }, [user])

  async function loadProfile() {
    const supabase = createClient()
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user!.id)
      .single()

    if (data) setProfile(data)
    setLoading(false)
  }

  async function handleSave() {
    if (!profile) return
    setSaving(true)

    const supabase = createClient()
    await supabase
      .from('profiles')
      .update(profile)
      .eq('id', user!.id)

    setSaving(false)
  }

  async function handleSignOut() {
    await signOut()
    router.push('/')
  }

  if (loading) return <div>Loading...</div>

  return (
    <div className="container max-w-2xl mx-auto py-8">
      <Card>
        <CardHeader>
          <CardTitle>Profile</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Email</label>
            <Input value={user?.email} disabled />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Full Name</label>
            <Input 
              value={profile?.full_name || ''} 
              onChange={(e) => setProfile({ ...profile!, full_name: e.target.value })}
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Certification</label>
            <select 
              className="w-full p-2 border rounded"
              value={profile?.certification_level || 'none'}
              onChange={(e) => setProfile({ ...profile!, certification_level: e.target.value })}
            >
              <option value="none">None</option>
              <option value="OW">Open Water</option>
              <option value="AOW">Advanced Open Water</option>
              <option value="rescue">Rescue Diver</option>
              <option value="divemaster">Divemaster</option>
              <option value="instructor">Instructor</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Total Dives</label>
            <Input 
              type="number"
              value={profile?.total_dives || 0} 
              onChange={(e) => setProfile({ ...profile!, total_dives: parseInt(e.target.value) })}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={handleSave} disabled={saving}>
              {saving ? 'Saving...' : 'Save Changes'}
            </Button>
            <Button variant="outline" onClick={handleSignOut}>
              Sign Out
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

### Step 2: Update Middleware

Update `src/middleware.ts`:

```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return request.cookies.get(name)?.value
        },
        set(name: string, value: string, options: any) {
          request.cookies.set({ name, value, ...options })
          response = NextResponse.next({ request: { headers: request.headers } })
          response.cookies.set({ name, value, ...options })
        },
        remove(name: string, options: any) {
          request.cookies.set({ name, value: '', ...options })
          response = NextResponse.next({ request: { headers: request.headers } })
          response.cookies.set({ name, value: '', ...options })
        },
      },
    }
  )

  const { data: { user } } = await supabase.auth.getUser()

  // Protect /profile and /chat routes
  if (!user && (request.nextUrl.pathname.startsWith('/profile') || request.nextUrl.pathname.startsWith('/chat'))) {
    return NextResponse.redirect(new URL('/auth/login?redirect=' + request.nextUrl.pathname, request.url))
  }

  // Redirect authenticated users away from auth pages
  if (user && request.nextUrl.pathname.startsWith('/auth/')) {
    return NextResponse.redirect(new URL('/', request.url))
  }

  return response
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

### Step 3: Add Header Navigation

Update `src/app/page.tsx` to add nav:

```typescript
import Link from 'next/link'
import { Button } from '@/components/ui/button'

export default function Home() {
  return (
    <>
      <header className="border-b">
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-2xl font-bold text-blue-600">DiveBuddy</h1>
          <nav className="flex gap-4">
            <Link href="/auth/login"><Button variant="ghost">Login</Button></Link>
            <Link href="/auth/signup"><Button>Sign Up</Button></Link>
          </nav>
        </div>
      </header>
      {/* Rest of homepage */}
    </>
  )
}
```

## Verification Checklist

- [ ] Profile page loads for authenticated users
- [ ] Profile updates save correctly
- [ ] Middleware redirects unauthenticated users
- [ ] Sign out works correctly
- [ ] Protected routes are inaccessible without auth

## Testing

1. Visit `/profile` while logged out → Redirected to login
2. Log in → Access profile page
3. Update profile fields → Save → Verify in database
4. Click Sign Out → Redirected to home

## Files Created

- ✅ `src/app/profile/page.tsx`
- ✅ `src/middleware.ts` (updated)
- ✅ `src/app/page.tsx` (updated with nav)

## PR 1.3 Complete! ✅

Authentication system fully implemented with:
- Email/password signup and login
- Profile management
- Protected routes
- Session persistence
- Password reset flow

**Next:** PR 1.4 - Chat UI Components
