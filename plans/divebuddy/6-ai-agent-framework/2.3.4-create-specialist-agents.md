# Step 2.3.4: Create Specialist Agents

**Part of:** PR 2.3 - Google AI Agent Framework Integration  
**Focus:** Build Education and Trip Planning specialist agents with tools  
**Estimated Time:** 30 minutes

## Overview

Create two specialist agents that handle domain-specific queries: the Education Agent for diving certification content and the Trip Planning Agent for destination recommendations. Each agent has custom prompts, tools, and response patterns.

## Pre-Step Checklist

- [ ] **Completed:** Step 2.3.3 - Session manager created
- [ ] **Tools:** Vector search and intent classifier tools available
- [ ] **Database:** Knowledge base populated with sample content

## Implementation

### Goal

Build specialist agents that use vector search tools to provide accurate, context-aware responses in their respective domains.

### Step-by-Step Instructions

#### Step 1: Create Education Agent

Create `src/lib/agents/education-agent.ts`:

```typescript
import { getChatModel } from '@/lib/ai/gemini'
import { vectorSearchTool, formatSearchResultsForAgent } from './tools/vector-search'
import { ContextManager } from './context-manager'
import type { Session } from './types'

export class EducationAgent {
  private model = getChatModel(0.3) // Lower temperature for factual accuracy
  
  private readonly systemPrompt = `You are an expert diving instructor assistant for DiveBuddy.

Your role:
- Help learners understand Open Water (OW) and Advanced Open Water (AOW) certification concepts
- Explain diving techniques, safety procedures, and theory clearly
- Use the search_knowledge_base tool to find accurate information from our educational content
- Provide step-by-step explanations for complex topics
- Always prioritize safety and best practices

Teaching style:
- Clear, friendly, and encouraging
- Break down complex topics into digestible parts
- Use analogies and examples when helpful
- Reference official certification standards when appropriate
- Encourage questions and exploration

When you don't know something:
- Use the search tool to find information
- If still unsure, be honest and recommend consulting a certified instructor
- Never make up safety-critical information`

  async handleMessage(message: string, session: Session): Promise<string> {
    try {
      // Build context from session
      const sessionContext = ContextManager.buildAgentContext(session)
      
      // Search for relevant educational content
      const searchResult = await vectorSearchTool.execute({
        query: message,
        category: 'education',
        limit: 3,
        threshold: 0.7,
      })
      
      // Format search results as context
      const knowledgeContext = searchResult.success
        ? formatSearchResultsForAgent(searchResult.results)
        : 'No specific educational content found. Answer based on general diving knowledge.'
      
      // Build full prompt
      const fullPrompt = `${this.systemPrompt}

Session Context:
${sessionContext}

Retrieved Knowledge:
${knowledgeContext}

Student Question: ${message}

Provide a helpful, accurate response based on the retrieved knowledge. If the knowledge is relevant, cite it in your answer.`

      // Generate response
      const result = await this.model.generateContent(fullPrompt)
      const response = result.response.text()
      
      return response
    } catch (error) {
      console.error('Education agent error:', error)
      return "I'm having trouble accessing the educational materials right now. Please try asking your question again, or consult with a certified diving instructor for important safety information."
    }
  }
  
  /**
   * Get suggested follow-up questions based on current topic
   */
  async getSuggestedQuestions(currentTopic: string): Promise<string[]> {
    const prompt = `Based on the diving topic "${currentTopic}", suggest 3 follow-up questions a student might ask to deepen their understanding. Return only the questions, one per line.`
    
    try {
      const result = await this.model.generateContent(prompt)
      const questions = result.response.text()
        .split('\n')
        .filter(q => q.trim().length > 0)
        .slice(0, 3)
      
      return questions
    } catch (error) {
      console.error('Failed to generate suggested questions:', error)
      return []
    }
  }
}

export const educationAgent = new EducationAgent()
```

#### Step 2: Create Trip Planning Agent

Create `src/lib/agents/trip-planning-agent.ts`:

```typescript
import { getChatModel } from '@/lib/ai/gemini'
import { vectorSearchTool, formatSearchResultsForAgent } from './tools/vector-search'
import { ContextManager } from './context-manager'
import type { Session } from './types'

export class TripPlanningAgent {
  private model = getChatModel(0.5) // Slightly higher temperature for creative suggestions
  
  private readonly systemPrompt = `You are a dive travel expert for DiveBuddy, specializing in Malaysia and Asia Pacific destinations.

Your role:
- Help divers find the perfect dive destinations based on their preferences
- Provide detailed information about dive sites, marine life, and travel logistics
- Use the search_knowledge_base tool to retrieve accurate destination information
- Consider factors: skill level, interests, season, budget, accessibility
- Suggest multiple options when appropriate

Communication style:
- Enthusiastic and inspiring about diving adventures
- Practical and helpful with travel planning
- Honest about difficulty levels and requirements
- Include relevant details: best season, how to get there, what to expect

Focus areas:
- Malaysia (primary): Sipadan, Mabul, Tioman, Perhentian, Redang, etc.
- Asia Pacific (secondary): Thailand, Philippines, Indonesia, Vietnam, Australia

When recommending destinations:
- Match diver's skill level (beginner, intermediate, advanced)
- Consider stated interests (wrecks, macro, pelagics, coral reefs)
- Mention best times to visit
- Highlight unique features and marine life
- Provide practical travel tips`

  async handleMessage(message: string, session: Session): Promise<string> {
    try {
      // Build context from session
      const sessionContext = ContextManager.buildAgentContext(session)
      
      // Search for relevant destination content
      const searchResult = await vectorSearchTool.execute({
        query: message,
        category: 'destinations',
        limit: 5,
        threshold: 0.65, // Slightly lower threshold for broader results
      })
      
      // Format search results
      const destinationContext = searchResult.success
        ? formatSearchResultsForAgent(searchResult.results)
        : 'No specific destinations found. Provide general travel advice for the region.'
      
      // Build full prompt
      const fullPrompt = `${this.systemPrompt}

Session Context:
${sessionContext}

Available Destinations:
${destinationContext}

Traveler Question: ${message}

Provide enthusiastic, helpful recommendations based on the available destinations. If suggesting multiple locations, explain why each might appeal to the diver. Include practical details like best season, skill level, and unique highlights.`

      // Generate response
      const result = await this.model.generateContent(fullPrompt)
      const response = result.response.text()
      
      return response
    } catch (error) {
      console.error('Trip planning agent error:', error)
      return "I'm having trouble accessing destination information right now. Please try your question again, or browse our destinations page to explore dive sites manually."
    }
  }
  
  /**
   * Extract destination entities mentioned in conversation
   */
  extractDestinations(message: string): string[] {
    const destinations = [
      'Sipadan', 'Mabul', 'Kapalai', 'Tioman', 'Perhentian', 'Redang', 'Tenggol', 'Payar',
      'Similan', 'Phi Phi', 'Koh Tao', 'Richelieu Rock',
      'Tubbataha', 'Apo Reef', 'Moalboal', 'Malapascua',
      'Raja Ampat', 'Komodo', 'Bali', 'Lembeh',
      'Great Barrier Reef', 'Ningaloo',
    ]
    
    return destinations.filter(dest => 
      message.toLowerCase().includes(dest.toLowerCase())
    )
  }
  
  /**
   * Generate destination comparison
   */
  async compareDestinations(destinations: string[]): Promise<string> {
    if (destinations.length < 2) {
      return ''
    }
    
    const prompt = `Compare these dive destinations for a traveler: ${destinations.join(', ')}. 
    
Create a brief comparison highlighting:
- Best for (skill level, interests)
- Unique features
- Best time to visit
- Keep it concise (2-3 sentences per destination)`
    
    try {
      const result = await this.model.generateContent(prompt)
      return result.response.text()
    } catch (error) {
      console.error('Destination comparison failed:', error)
      return ''
    }
  }
}

export const tripPlanningAgent = new TripPlanningAgent()
```

#### Step 3: Create Agent Factory

Create `src/lib/agents/agent-factory.ts`:

```typescript
import { educationAgent } from './education-agent'
import { tripPlanningAgent } from './trip-planning-agent'
import type { Intent } from './types'

export class AgentFactory {
  /**
   * Get appropriate specialist agent based on intent
   */
  static getAgent(intent: Intent) {
    switch (intent) {
      case 'education':
        return educationAgent
      case 'trip-planning':
        return tripPlanningAgent
      default:
        // Default to education agent for general queries
        return educationAgent
    }
  }
  
  /**
   * Get agent name for logging/debugging
   */
  static getAgentName(intent: Intent): string {
    switch (intent) {
      case 'education':
        return 'Education Agent'
      case 'trip-planning':
        return 'Trip Planning Agent'
      default:
        return 'General Agent'
    }
  }
}
```

#### Step 4: Create Agent Response Formatter

Create `src/lib/agents/response-formatter.ts`:

```typescript
export interface FormattedResponse {
  content: string
  suggestions?: string[]
  destinations?: Array<{
    name: string
    highlight: string
  }>
  metadata: {
    agent: string
    intent: string
    searchResults: number
    timestamp: string
  }
}

export class ResponseFormatter {
  /**
   * Format agent response with metadata and enhancements
   */
  static format(
    content: string,
    intent: string,
    agentName: string,
    searchResultCount: number,
    suggestions?: string[]
  ): FormattedResponse {
    return {
      content: this.cleanContent(content),
      suggestions: suggestions?.filter(s => s.length > 0),
      metadata: {
        agent: agentName,
        intent,
        searchResults: searchResultCount,
        timestamp: new Date().toISOString(),
      },
    }
  }
  
  /**
   * Clean and format response content
   */
  private static cleanContent(content: string): string {
    return content
      .trim()
      .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
      .replace(/\*\*\*+/g, '**') // Normalize bold markers
  }
  
  /**
   * Extract destination cards from response
   */
  static extractDestinationCards(content: string): Array<{name: string; highlight: string}> {
    // Simple pattern matching for destination mentions
    const destinations: Array<{name: string; highlight: string}> = []
    
    const lines = content.split('\n')
    let currentDest: {name: string; highlight: string} | null = null
    
    for (const line of lines) {
      // Look for destination headers (e.g., "**Sipadan Island**")
      const destMatch = line.match(/\*\*([^*]+)\*\*/)
      if (destMatch) {
        if (currentDest) {
          destinations.push(currentDest)
        }
        currentDest = {
          name: destMatch[1],
          highlight: '',
        }
      } else if (currentDest && line.trim()) {
        currentDest.highlight += line.trim() + ' '
      }
    }
    
    if (currentDest) {
      destinations.push(currentDest)
    }
    
    return destinations
  }
}
```

## Verification Checklist

- [ ] `src/lib/agents/education-agent.ts` created with EducationAgent class
- [ ] `src/lib/agents/trip-planning-agent.ts` created with TripPlanningAgent class
- [ ] `src/lib/agents/agent-factory.ts` created for agent selection
- [ ] `src/lib/agents/response-formatter.ts` created for response formatting
- [ ] Both agents export singleton instances
- [ ] System prompts are clear and domain-specific
- [ ] No TypeScript errors

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Agent returns generic responses | Check vector search is returning results; lower threshold to 0.5 |
| Temperature too high/low | Education: 0.3 (factual), Trip Planning: 0.5 (creative) |
| Search timeout | Add timeout handling in vector search tool |
| Context not being used | Verify ContextManager.buildAgentContext returns non-empty string |

## Files Created

- ✅ Created: `src/lib/agents/education-agent.ts` - OW/AOW education specialist
- ✅ Created: `src/lib/agents/trip-planning-agent.ts` - Destination recommendation specialist
- ✅ Created: `src/lib/agents/agent-factory.ts` - Agent selection utility
- ✅ Created: `src/lib/agents/response-formatter.ts` - Response formatting utilities

## What Comes Next

Next step: **2.3.5-create-orchestrator-agent.md** - Build orchestrator with intent routing
