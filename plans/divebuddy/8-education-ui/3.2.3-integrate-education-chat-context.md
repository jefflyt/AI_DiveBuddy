# Step 3.2.3: Integrate Education Context with Chat

**Part of:** PR 3.2 - Education Mode & Topic Navigation  
**Focus:** Enhance chat to accept education context for AI tutoring  
**Files to Modify:** `app/chat/page.tsx`, `app/api/chat/route.ts`  
**Estimated Time:** 20 minutes

## Overview

Modify the chat interface to accept URL parameters that pre-load education topic context. When users click "Ask AI Tutor" from a topic page, the chat should be aware of what they're studying and provide contextual assistance.

## Pre-Substep Checklist

- [ ] **Completed:** Step 3.2.2 - Topic detail pages with "Ask AI Tutor" buttons
- [ ] **Working:** Chat interface from Phase 1
- [ ] **Google AI Agent:** Orchestrator and Education Agent implemented
- [ ] **Vector search:** RAG pipeline functional

## Implementation

### Goal

Allow chat to accept `?context=education&topic={topic-id}` parameters and automatically load relevant context for the Education Agent.

### Step-by-Step Instructions

#### Step 1: Update Chat Page to Accept Context

- [ ] Modify `app/chat/page.tsx` to read URL parameters:

```typescript
'use client'

import { useChat } from 'ai/react'
import { useSearchParams } from 'next/navigation'
import { useEffect, useState } from 'react'
import { ChatMessages } from '@/components/chat/ChatMessages'
import { ChatInput } from '@/components/chat/ChatInput'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { BookOpen, X } from 'lucide-react'
import Link from 'next/link'

export default function ChatPage() {
  const searchParams = useSearchParams()
  const context = searchParams?.get('context')
  const topicId = searchParams?.get('topic')

  const [topicInfo, setTopicInfo] = useState<any>(null)
  const [isLoadingTopic, setIsLoadingTopic] = useState(false)

  // Fetch topic information if education context
  useEffect(() => {
    if (context === 'education' && topicId) {
      setIsLoadingTopic(true)
      fetch(`/api/education/topics/${topicId}`)
        .then((res) => res.json())
        .then((data) => {
          setTopicInfo(data)
          setIsLoadingTopic(false)
        })
        .catch(() => {
          setIsLoadingTopic(false)
        })
    }
  }, [context, topicId])

  const { messages, input, handleInputChange, handleSubmit, isLoading } = useChat({
    api: '/api/chat',
    body: {
      context: context || undefined,
      topicId: topicId || undefined,
    },
    initialMessages: topicInfo
      ? [
          {
            id: 'system-context',
            role: 'assistant',
            content: `I'm ready to help you learn about "${topicInfo.title}". Ask me anything about this topic!`,
          },
        ]
      : [],
  })

  return (
    <div className="flex flex-col h-screen bg-gray-50">
      {/* Context Banner */}
      {context === 'education' && topicInfo && (
        <div className="bg-blue-50 border-b border-blue-200 px-4 py-3">
          <div className="container mx-auto max-w-4xl flex items-center justify-between">
            <div className="flex items-center gap-3">
              <BookOpen className="w-5 h-5 text-blue-600" />
              <div>
                <p className="text-sm font-medium text-blue-900">
                  AI Tutor: {topicInfo.title}
                </p>
                <p className="text-xs text-blue-700">
                  {topicInfo.metadata?.module} • {topicInfo.metadata?.estimatedReadTime}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Button asChild variant="ghost" size="sm">
                <Link href={`/learn/${topicInfo.certification?.toLowerCase()}/${topicId}`}>
                  Back to Topic
                </Link>
              </Button>
              <Button asChild variant="ghost" size="icon">
                <Link href="/chat">
                  <X className="w-4 h-4" />
                </Link>
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Chat Container */}
      <div className="flex-1 overflow-hidden">
        <div className="container mx-auto max-w-4xl h-full flex flex-col">
          <ChatMessages messages={messages} isLoading={isLoading} />
          <ChatInput
            input={input}
            handleInputChange={handleInputChange}
            handleSubmit={handleSubmit}
            isLoading={isLoading}
            placeholder={
              context === 'education'
                ? 'Ask a question about this topic...'
                : 'Ask me anything about diving...'
            }
          />
        </div>
      </div>
    </div>
  )
}
```

#### Step 2: Create Topic API Endpoint

- [ ] Create `app/api/education/topics/[topicId]/route.ts`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export async function GET(
  request: NextRequest,
  { params }: { params: { topicId: string } }
) {
  const supabase = createServerClient()

  // Fetch topic document
  const { data: document, error } = await supabase
    .from('documents')
    .select('*')
    .eq('category', 'education')
    .eq('metadata->>id', params.topicId)
    .single()

  if (error || !document) {
    return NextResponse.json(
      { error: 'Topic not found' },
      { status: 404 }
    )
  }

  return NextResponse.json({
    id: document.metadata?.id || document.id,
    title: document.title,
    content: document.content,
    certification: document.subcategory,
    metadata: document.metadata,
  })
}
```

#### Step 3: Update Chat API to Use Education Context

- [ ] Modify `app/api/chat/route.ts` to handle education context:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { OrchestratorAgent } from '@/lib/agents/orchestrator'
import { EducationAgent } from '@/lib/agents/education'
import { TripPlanningAgent } from '@/lib/agents/trip-planning'
import { StreamingTextResponse } from 'ai'

export const runtime = 'edge'

export async function POST(req: Request) {
  const { messages, context, topicId } = await req.json()

  const supabase = createServerClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    return new Response('Unauthorized', { status: 401 })
  }

  // Initialize agents
  const educationAgent = new EducationAgent()
  const tripPlanningAgent = new TripPlanningAgent()
  const orchestrator = new OrchestratorAgent([educationAgent, tripPlanningAgent])

  // If education context, load topic information
  let systemContext = ''
  if (context === 'education' && topicId) {
    const { data: topic } = await supabase
      .from('documents')
      .select('*')
      .eq('category', 'education')
      .eq('metadata->>id', topicId)
      .single()

    if (topic) {
      systemContext = `
EDUCATION CONTEXT:
You are currently helping the user learn about: "${topic.title}"
Module: ${topic.metadata?.module}
Certification: ${topic.subcategory}
Difficulty: ${topic.metadata?.difficulty}

The user has access to the full content of this topic. When answering questions:
1. Relate answers specifically to this topic
2. Reference concepts from the content when appropriate
3. Suggest related topics if the question goes beyond the current scope
4. Encourage hands-on practice and understanding

Topic Summary:
${topic.content.slice(0, 500)}...
`
    }
  }

  try {
    // Route through orchestrator with optional system context
    const response = await orchestrator.chat({
      messages,
      userId: user.id,
      systemContext: systemContext || undefined,
    })

    // Return streaming response
    return new StreamingTextResponse(response.stream)
  } catch (error) {
    console.error('Chat error:', error)
    return new Response('Internal Server Error', { status: 500 })
  }
}
```

#### Step 4: Update Orchestrator Agent to Use System Context

- [ ] Modify `lib/agents/orchestrator.ts` to accept system context:

```typescript
import { GoogleGenerativeAI } from '@google/generative-ai'

export class OrchestratorAgent {
  private genAI: GoogleGenerativeAI
  private agents: any[]

  constructor(agents: any[]) {
    this.genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)
    this.agents = agents
  }

  async chat({
    messages,
    userId,
    systemContext,
  }: {
    messages: any[]
    userId: string
    systemContext?: string
  }) {
    const model = this.genAI.getGenerativeModel({ model: 'gemini-1.5-flash' })

    // Build system instruction with optional context
    let systemInstruction = `You are DiveBuddy, an AI assistant for scuba diving education and trip planning.
You have access to specialized agents for different tasks.

Available Agents:
- Education Agent: Answers questions about diving theory, skills, and certifications
- Trip Planning Agent: Helps plan diving trips, find destinations, and get local information

Your role is to:
1. Understand user intent
2. Route questions to the appropriate agent
3. Synthesize responses when multiple agents are needed
4. Provide helpful, accurate information about diving`

    if (systemContext) {
      systemInstruction += '\n\n' + systemContext
    }

    // Determine which agent to use based on latest message
    const latestMessage = messages[messages.length - 1]?.content || ''
    const selectedAgent = this.selectAgent(latestMessage)

    // Generate response using selected agent
    const chat = model.startChat({
      history: messages.slice(0, -1).map((msg) => ({
        role: msg.role === 'user' ? 'user' : 'model',
        parts: [{ text: msg.content }],
      })),
      systemInstruction,
    })

    const result = await chat.sendMessageStream(latestMessage)

    return {
      stream: result.stream,
      agent: selectedAgent,
    }
  }

  private selectAgent(message: string): string {
    const lowerMessage = message.toLowerCase()

    // Education keywords
    const educationKeywords = [
      'learn',
      'teach',
      'explain',
      'what is',
      'how do',
      'certification',
      'skill',
      'theory',
      'buoyancy',
      'equipment',
    ]

    // Trip planning keywords
    const tripKeywords = [
      'trip',
      'destination',
      'travel',
      'where',
      'plan',
      'dive site',
      'malaysia',
      'thailand',
      'indonesia',
    ]

    const educationScore = educationKeywords.filter((kw) =>
      lowerMessage.includes(kw)
    ).length
    const tripScore = tripKeywords.filter((kw) => lowerMessage.includes(kw)).length

    return educationScore >= tripScore ? 'education' : 'trip-planning'
  }
}
```

## Verification Checklist

- [ ] Chat page accepts `context` and `topicId` URL parameters
- [ ] Topic info API endpoint created at `/api/education/topics/[topicId]`
- [ ] Context banner displays when education mode active
- [ ] Chat API receives and processes education context
- [ ] Orchestrator uses system context in responses
- [ ] "Back to Topic" link works correctly
- [ ] Clearing context (X button) returns to normal chat
- [ ] AI responses are contextually relevant to the topic

## Testing

1. **Test education context from topic page:**
   - Go to topic: `http://localhost:3000/learn/ow/ow-equipment-overview`
   - Click "Ask AI Tutor" button
   - Should redirect to: `/chat?context=education&topic=ow-equipment-overview`
   - Context banner should appear with topic title

2. **Test AI responses:**
   - Ask: "What equipment do I need?"
   - Should reference content from the Equipment Overview topic
   - Ask: "Tell me about buoyancy"
   - Should suggest related topics if appropriate

3. **Test context switching:**
   - Click X to clear context → banner disappears
   - Click "Back to Topic" → returns to topic detail page
   - Navigate to `/chat` directly → no context banner

4. **Test API endpoint:**
   ```bash
   curl http://localhost:3000/api/education/topics/ow-equipment-overview
   ```
   Should return topic JSON

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Context banner not showing | Check `searchParams` is being read correctly; ensure topic API returns data |
| Topic API 404 error | Verify topic ID matches `metadata->>id` in database |
| AI not using context | Check `systemContext` is being passed to Gemini chat model |
| Initial message not appearing | Ensure `initialMessages` in `useChat` is set correctly |
| Streaming broken | Verify `StreamingTextResponse` import from `ai` package |
| "Back to Topic" link incorrect | Check topic certification is lowercase in URL construction |
| Context persists after clearing | Ensure clicking X navigates to `/chat` without params |

## Files Modified

- [ ] ✅ Modified: `app/chat/page.tsx` (added URL param handling and context banner)
- [ ] ✅ Created: `app/api/education/topics/[topicId]/route.ts` (topic info endpoint)
- [ ] ✅ Modified: `app/api/chat/route.ts` (added education context processing)
- [ ] ✅ Modified: `lib/agents/orchestrator.ts` (added systemContext parameter)

## What Comes Next

**Next Substep:** 3.2.4 - Add Certification Progress Badge Display

Create UI components that display user progress badges and certificates earned from completing education modules.
