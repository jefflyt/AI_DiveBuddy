# Step 3.2.2: Create Topic Browse & Detail Pages

**Part of:** PR 3.2 - Education Mode & Topic Navigation  
**Focus:** Build module navigation and topic reading experience  
**Files to Create:** `app/learn/[certification]/page.tsx`, `app/learn/[certification]/[topic]/page.tsx`, `components/education/TopicCard.tsx`  
**Estimated Time:** 25 minutes

## Overview

Create the topic browsing interface showing all modules for a certification, and individual topic detail pages that render markdown content with reading progress tracking.

## Pre-Substep Checklist

- [ ] **Completed:** Step 3.2.1 - Education landing page created
- [ ] **Content exists:** Education markdown files in `data/education/`
- [ ] **Database seeded:** Topics available in Supabase `documents` table
- [ ] **shadcn/ui:** Card, Badge, Separator components installed

## Implementation

### Goal

Allow users to browse all topics in a certification path and read individual topic content with progress tracking.

### Step-by-Step Instructions

#### Step 1: Create Topic Card Component

- [ ] Create `components/education/TopicCard.tsx`:

```typescript
'use client'

import Link from 'next/link'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { CheckCircle2, Circle, Clock, BookOpen } from 'lucide-react'

interface TopicCardProps {
  id: string
  title: string
  description: string
  certification: 'OW' | 'AOW'
  module: string
  difficulty: 'beginner' | 'intermediate' | 'advanced'
  estimatedReadTime: string
  tags: string[]
  completed: boolean
  href: string
}

export function TopicCard({
  id,
  title,
  description,
  certification,
  module,
  difficulty,
  estimatedReadTime,
  tags,
  completed,
  href,
}: TopicCardProps) {
  const difficultyColors = {
    beginner: 'bg-green-100 text-green-800',
    intermediate: 'bg-yellow-100 text-yellow-800',
    advanced: 'bg-red-100 text-red-800',
  }

  return (
    <Link href={href}>
      <Card className="hover:shadow-md transition-all hover:border-blue-300 cursor-pointer">
        <CardHeader>
          <div className="flex items-start justify-between gap-2">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <Badge variant="outline" className="text-xs">
                  {module}
                </Badge>
                <Badge variant="outline" className={`text-xs ${difficultyColors[difficulty]}`}>
                  {difficulty}
                </Badge>
              </div>
              <CardTitle className="text-lg leading-tight">{title}</CardTitle>
            </div>
            {completed ? (
              <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0" />
            ) : (
              <Circle className="w-5 h-5 text-gray-300 flex-shrink-0" />
            )}
          </div>
          <CardDescription className="line-clamp-2">{description}</CardDescription>
        </CardHeader>

        <CardContent>
          <div className="flex items-center gap-4 text-sm text-muted-foreground">
            <div className="flex items-center gap-1.5">
              <Clock className="w-4 h-4" />
              <span>{estimatedReadTime}</span>
            </div>
            <div className="flex items-center gap-1.5">
              <BookOpen className="w-4 h-4" />
              <span>{certification}</span>
            </div>
          </div>

          {tags.length > 0 && (
            <div className="flex flex-wrap gap-1.5 mt-3">
              {tags.slice(0, 3).map((tag) => (
                <Badge key={tag} variant="secondary" className="text-xs">
                  {tag}
                </Badge>
              ))}
              {tags.length > 3 && (
                <Badge variant="secondary" className="text-xs">
                  +{tags.length - 3}
                </Badge>
              )}
            </div>
          )}
        </CardContent>
      </Card>
    </Link>
  )
}
```

#### Step 2: Create Certification Browse Page

- [ ] Create `app/learn/[certification]/page.tsx`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { redirect, notFound } from 'next/navigation'
import { TopicCard } from '@/components/education/TopicCard'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { ArrowLeft, GraduationCap } from 'lucide-react'
import Link from 'next/link'

interface PageProps {
  params: {
    certification: string
  }
}

const certificationInfo = {
  ow: {
    title: 'Open Water Diver',
    description: 'Master fundamental diving skills, equipment, and safety procedures',
    badge: 'OW',
  },
  aow: {
    title: 'Advanced Open Water',
    description: 'Expand your skills with advanced techniques and specialty diving',
    badge: 'AOW',
  },
}

async function getTopics(certification: string) {
  const supabase = createServerClient()

  // Get all topics for this certification
  const { data: documents, error } = await supabase
    .from('documents')
    .select('*')
    .eq('category', 'education')
    .eq('subcategory', certification.toUpperCase())
    .order('metadata->module', { ascending: true })

  if (error) {
    console.error('Error fetching topics:', error)
    return []
  }

  return documents || []
}

async function getUserProgress(userId: string, certification: string) {
  const supabase = createServerClient()

  const { data: progress, error } = await supabase
    .from('user_progress')
    .select('topic_id, completed')
    .eq('user_id', userId)
    .eq('certification', certification.toUpperCase())

  if (error) {
    console.error('Error fetching progress:', error)
    return {}
  }

  // Convert to map for quick lookup
  return (progress || []).reduce((acc, p) => {
    acc[p.topic_id] = p.completed
    return acc
  }, {} as Record<string, boolean>)
}

export default async function CertificationPage({ params }: PageProps) {
  const { certification } = params

  if (!['ow', 'aow'].includes(certification)) {
    notFound()
  }

  const supabase = createServerClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect(`/auth/login?redirect=/learn/${certification}`)
  }

  const info = certificationInfo[certification as keyof typeof certificationInfo]
  const topics = await getTopics(certification)
  const progress = await getUserProgress(user.id, certification)

  // Calculate progress
  const completedCount = Object.values(progress).filter(Boolean).length
  const progressPercentage = topics.length > 0 
    ? Math.round((completedCount / topics.length) * 100)
    : 0

  // Group topics by module
  const topicsByModule = topics.reduce((acc, topic) => {
    const module = topic.metadata?.module || 'Other'
    if (!acc[module]) acc[module] = []
    acc[module].push(topic)
    return acc
  }, {} as Record<string, typeof topics>)

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b">
        <div className="container mx-auto px-4 py-6">
          <Link
            href="/learn"
            className="inline-flex items-center text-sm text-muted-foreground hover:text-foreground mb-4"
          >
            <ArrowLeft className="w-4 h-4 mr-1" />
            Back to Certifications
          </Link>

          <div className="flex items-start justify-between gap-4">
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-blue-100 rounded-lg">
                  <GraduationCap className="w-6 h-6 text-blue-600" />
                </div>
                <Badge variant="outline" className="bg-blue-50 text-blue-700">
                  {info.badge}
                </Badge>
              </div>
              <h1 className="text-3xl font-bold mb-2">{info.title}</h1>
              <p className="text-muted-foreground">{info.description}</p>
            </div>

            {/* Progress Summary */}
            <div className="text-right">
              <div className="text-3xl font-bold text-blue-600">
                {progressPercentage}%
              </div>
              <div className="text-sm text-muted-foreground">
                {completedCount} of {topics.length} completed
              </div>
            </div>
          </div>

          {/* Progress Bar */}
          <div className="mt-6">
            <Progress value={progressPercentage} className="h-2" />
          </div>
        </div>
      </div>

      {/* Topics Grid */}
      <div className="container mx-auto px-4 py-8">
        {Object.entries(topicsByModule).length === 0 ? (
          <div className="text-center py-12">
            <p className="text-muted-foreground">No topics found for this certification.</p>
            <p className="text-sm text-muted-foreground mt-2">
              Run the seed script to populate content.
            </p>
          </div>
        ) : (
          <div className="space-y-8">
            {Object.entries(topicsByModule).map(([module, moduleTopics]) => (
              <div key={module}>
                <h2 className="text-2xl font-semibold mb-4">{module}</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {moduleTopics.map((topic) => (
                    <TopicCard
                      key={topic.id}
                      id={topic.metadata?.id || topic.id}
                      title={topic.title}
                      description={topic.metadata?.description || 'Learn about this topic'}
                      certification={certification.toUpperCase() as 'OW' | 'AOW'}
                      module={topic.metadata?.module || module}
                      difficulty={topic.metadata?.difficulty || 'beginner'}
                      estimatedReadTime={topic.metadata?.estimatedReadTime || '10 min'}
                      tags={topic.metadata?.tags || []}
                      completed={progress[topic.metadata?.id] || false}
                      href={`/learn/${certification}/${topic.metadata?.id || topic.id}`}
                    />
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}
```

#### Step 3: Create Topic Detail Page

- [ ] Create `app/learn/[certification]/[topic]/page.tsx`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { redirect, notFound } from 'next/navigation'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import { ArrowLeft, MessageSquare, CheckCircle2 } from 'lucide-react'
import Link from 'next/link'
import ReactMarkdown from 'react-markdown'

interface PageProps {
  params: {
    certification: string
    topic: string
  }
}

async function getTopic(topicId: string, certification: string) {
  const supabase = createServerClient()

  const { data: document, error } = await supabase
    .from('documents')
    .select('*')
    .eq('category', 'education')
    .eq('subcategory', certification.toUpperCase())
    .eq('metadata->>id', topicId)
    .single()

  if (error || !document) {
    return null
  }

  return document
}

async function markTopicCompleted(userId: string, topicId: string, certification: string) {
  'use server'
  
  const supabase = createServerClient()

  await supabase.from('user_progress').upsert({
    user_id: userId,
    topic_id: topicId,
    certification: certification.toUpperCase(),
    completed: true,
    completed_at: new Date().toISOString(),
  })
}

export default async function TopicPage({ params }: PageProps) {
  const { certification, topic } = params

  if (!['ow', 'aow'].includes(certification)) {
    notFound()
  }

  const supabase = createServerClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect(`/auth/login?redirect=/learn/${certification}/${topic}`)
  }

  const document = await getTopic(topic, certification)

  if (!document) {
    notFound()
  }

  // Check if user completed this topic
  const { data: progress } = await supabase
    .from('user_progress')
    .select('completed')
    .eq('user_id', user.id)
    .eq('topic_id', topic)
    .single()

  const isCompleted = progress?.completed || false

  return (
    <div className="min-h-screen bg-white">
      {/* Header */}
      <div className="border-b sticky top-0 bg-white z-10">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <Link
              href={`/learn/${certification}`}
              className="inline-flex items-center text-sm text-muted-foreground hover:text-foreground"
            >
              <ArrowLeft className="w-4 h-4 mr-1" />
              Back to {certification.toUpperCase()} Topics
            </Link>

            <div className="flex items-center gap-3">
              <Button asChild variant="outline" size="sm">
                <Link href={`/chat?context=education&topic=${topic}`}>
                  <MessageSquare className="w-4 h-4 mr-2" />
                  Ask AI Tutor
                </Link>
              </Button>

              {isCompleted && (
                <Badge variant="outline" className="bg-green-50 text-green-700 border-green-200">
                  <CheckCircle2 className="w-3 h-3 mr-1" />
                  Completed
                </Badge>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Content */}
      <article className="container mx-auto px-4 py-8 max-w-4xl">
        {/* Title & Metadata */}
        <div className="mb-8">
          <div className="flex flex-wrap gap-2 mb-4">
            <Badge variant="outline">{document.metadata?.module}</Badge>
            <Badge variant="outline" className="capitalize">
              {document.metadata?.difficulty}
            </Badge>
            <Badge variant="secondary">{document.metadata?.estimatedReadTime}</Badge>
          </div>

          <h1 className="text-4xl font-bold mb-4">{document.title}</h1>

          {document.metadata?.tags && (
            <div className="flex flex-wrap gap-2">
              {document.metadata.tags.map((tag: string) => (
                <Badge key={tag} variant="secondary" className="text-xs">
                  {tag}
                </Badge>
              ))}
            </div>
          )}
        </div>

        <Separator className="my-8" />

        {/* Markdown Content */}
        <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-h2:text-2xl prose-h3:text-xl prose-p:text-base prose-p:leading-relaxed prose-li:text-base prose-strong:text-blue-700 prose-a:text-blue-600">
          <ReactMarkdown>{document.content}</ReactMarkdown>
        </div>

        <Separator className="my-8" />

        {/* Actions */}
        <div className="flex items-center justify-between">
          {!isCompleted && (
            <form action={markTopicCompleted.bind(null, user.id, topic, certification)}>
              <Button type="submit" size="lg">
                <CheckCircle2 className="w-4 h-4 mr-2" />
                Mark as Complete
              </Button>
            </form>
          )}

          <Button asChild variant="outline" size="lg">
            <Link href={`/chat?context=education&topic=${topic}`}>
              <MessageSquare className="w-4 h-4 mr-2" />
              Discuss with AI Tutor
            </Link>
          </Button>
        </div>
      </article>
    </div>
  )
}
```

#### Step 4: Install ReactMarkdown

- [ ] Install markdown renderer:

```bash
npm install react-markdown
```

#### Step 5: Update Placeholder Pages

- [ ] Replace `app/learn/ow/page.tsx` content (remove redirect):

```typescript
export { default } from '../[certification]/page'
```

- [ ] Replace `app/learn/aow/page.tsx` content:

```typescript
export { default } from '../[certification]/page'
```

## Verification Checklist

- [ ] Component created: `components/education/TopicCard.tsx`
- [ ] Page created: `app/learn/[certification]/page.tsx`
- [ ] Page created: `app/learn/[certification]/[topic]/page.tsx`
- [ ] ReactMarkdown installed and working
- [ ] Topics display in grid layout grouped by module
- [ ] Individual topic pages render markdown correctly
- [ ] "Mark as Complete" button works
- [ ] "Ask AI Tutor" button links to chat with context
- [ ] Progress tracking updates when topic marked complete
- [ ] Back navigation works correctly

## Testing

1. **Browse topics:**
   ```
   http://localhost:3000/learn/ow
   ```
   - Should show all OW topics grouped by module
   - Progress bar shows overall completion

2. **View topic detail:**
   ```
   http://localhost:3000/learn/ow/ow-equipment-overview
   ```
   - Markdown content renders with proper styling
   - "Mark as Complete" button visible (if not completed)
   - "Ask AI Tutor" button links to chat

3. **Test progress tracking:**
   - Click "Mark as Complete" → should redirect and show completed badge
   - Return to browse page → progress should update

4. **Test chat integration:**
   - Click "Ask AI Tutor" → should open chat with `?context=education&topic=ow-equipment-overview`

## Troubleshooting

| Issue | Solution |
|-------|----------|
| No topics showing | Run seed script: `npm run seed:education` |
| Markdown not rendering | Install react-markdown: `npm install react-markdown` |
| Prose styles not working | Tailwind Typography plugin needed: `npm install -D @tailwindcss/typography`, add to `tailwind.config.js` |
| Progress not updating | Check RLS policies on `user_progress` table allow upserts |
| "Mark as Complete" doesn't work | Verify server action syntax (use `'use server'` directive) |
| Topic page 404 error | Check `metadata->>id` matches topic slug in URL |
| Back button navigation broken | Ensure `certification` param matches `ow` or `aow` |

## Files Modified

- [ ] ✅ Created: `components/education/TopicCard.tsx`
- [ ] ✅ Created: `app/learn/[certification]/page.tsx`
- [ ] ✅ Created: `app/learn/[certification]/[topic]/page.tsx`
- [ ] ✅ Modified: `app/learn/ow/page.tsx` (export from dynamic route)
- [ ] ✅ Modified: `app/learn/aow/page.tsx` (export from dynamic route)
- [ ] ✅ Modified: `package.json` (added react-markdown)

## What Comes Next

**Next Substep:** 3.2.3 - Integrate Education Context with Chat

Modify the chat interface to accept education context and load relevant topic information for AI tutoring.
