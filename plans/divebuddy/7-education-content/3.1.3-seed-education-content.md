# Step 3.1.3: Seed Education Content to Database

**Part of:** PR 3.1 - OW/AOW Original Content Creation  
**Focus:** Embed and store educational content in Supabase with vector embeddings  
**File to Create:** `scripts/seed-education.ts`  
**Estimated Time:** 15 minutes

## Overview

Create a script that processes all OW/AOW markdown content, generates vector embeddings using Gemini, and stores them in Supabase for RAG retrieval. This makes the educational content searchable by the Education Agent.

## Pre-Substep Checklist

- [ ] **Completed:** Step 3.1.2 - OW Module 1 content written
- [ ] **Content exists:** At least 5+ markdown files in `data/education/open-water/`
- [ ] **Database ready:** Supabase tables created with pgvector enabled
- [ ] **Gemini API:** Key configured in `.env.local`

## Implementation

### Goal

Process educational markdown files, chunk content, generate embeddings, and store in Supabase for vector search.

### Step-by-Step Instructions

#### Step 1: Create Seed Script

- [ ] Create `scripts/seed-education.ts`:

```typescript
import { createClient } from '@supabase/supabase-js'
import { generateEmbeddings } from '@/lib/gemini/client'
import { chunkText } from '@/lib/embeddings/chunker'
import { readdir, readFile } from 'fs/promises'
import { join } from 'path'
import matter from 'gray-matter'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // Use service role for seeding
)

interface ContentFile {
  path: string
  frontmatter: any
  content: string
}

async function loadEducationContent(directory: string): Promise<ContentFile[]> {
  const files: ContentFile[] = []
  const entries = await readdir(directory)

  for (const entry of entries) {
    if (entry.startsWith('_') || entry.startsWith('.')) continue
    if (!entry.endsWith('.md')) continue

    const filePath = join(directory, entry)
    const fileContent = await readFile(filePath, 'utf-8')
    const { data: frontmatter, content } = matter(fileContent)

    files.push({ path: filePath, frontmatter, content })
  }

  return files
}

async function seedDocument(file: ContentFile) {
  const { frontmatter, content } = file

  console.log(`üìÑ Processing: ${frontmatter.title || 'Untitled'}`)

  // 1. Insert document
  const { data: document, error: docError } = await supabase
    .from('documents')
    .insert({
      title: frontmatter.title,
      content: content,
      category: 'education',
      subcategory: frontmatter.certification || 'OW',
      metadata: {
        id: frontmatter.id,
        module: frontmatter.module,
        difficulty: frontmatter.difficulty,
        estimatedReadTime: frontmatter.estimatedReadTime,
        tags: frontmatter.tags || [],
        version: frontmatter.version,
        lastUpdated: frontmatter.lastUpdated,
      },
    })
    .select()
    .single()

  if (docError) {
    console.error(`‚ùå Failed to insert document: ${docError.message}`)
    return
  }

  // 2. Chunk the content
  const chunks = chunkText(content, {
    chunkSize: 800,
    overlap: 150,
    minChunkSize: 100,
  })

  console.log(`  ‚úÇÔ∏è  Created ${chunks.length} chunks`)

  // 3. Generate embeddings
  const chunkTexts = chunks.map(c => c.content)
  const embeddings = await generateEmbeddings(chunkTexts)

  console.log(`  üß† Generated ${embeddings.length} embeddings`)

  // 4. Insert chunks with embeddings
  const chunksWithEmbeddings = chunks.map((chunk, i) => ({
    document_id: document.id,
    content: chunk.content,
    chunk_index: chunk.index,
    embedding: JSON.stringify(embeddings[i]),
    metadata: {
      ...chunk.metadata,
      module: frontmatter.module,
      certification: frontmatter.certification,
    },
  }))

  const { error: chunkError } = await supabase
    .from('document_chunks')
    .insert(chunksWithEmbeddings)

  if (chunkError) {
    console.error(`‚ùå Failed to insert chunks: ${chunkError.message}`)
    return
  }

  console.log(`  ‚úÖ Stored ${chunks.length} chunks with embeddings\n`)
}

async function main() {
  console.log('üöÄ Starting education content seeding...\n')

  // Load OW content
  console.log('üìö Loading Open Water content...')
  const owPath = join(process.cwd(), 'data/education/open-water')
  const owFiles = await loadEducationContent(owPath)
  console.log(`Found ${owFiles.length} OW files\n`)

  // Load AOW content
  console.log('üìö Loading Advanced Open Water content...')
  const aowPath = join(process.cwd(), 'data/education/advanced-open-water')
  let aowFiles: ContentFile[] = []
  try {
    aowFiles = await loadEducationContent(aowPath)
    console.log(`Found ${aowFiles.length} AOW files\n`)
  } catch (err) {
    console.log('No AOW content found (this is ok for initial seeding)\n')
  }

  // Process all files
  const allFiles = [...owFiles, ...aowFiles]

  for (const file of allFiles) {
    await seedDocument(file)
    // Rate limiting: wait 100ms between requests to avoid hitting Gemini API limits
    await new Promise(resolve => setTimeout(resolve, 100))
  }

  console.log('‚ú® Education content seeding complete!')
  console.log(`Total documents: ${allFiles.length}`)

  // Verify in database
  const { count } = await supabase
    .from('documents')
    .select('*', { count: 'exact', head: true })
    .eq('category', 'education')

  console.log(`Documents in database: ${count}`)

  process.exit(0)
}

main().catch((error) => {
  console.error('Fatal error:', error)
  process.exit(1)
})
```

#### Step 2: Install Dependencies

- [ ] Install required packages:

```bash
npm install gray-matter tsx
```

#### Step 3: Add Service Role Key to Environment

- [ ] Add to `.env.local` (get from Supabase Dashboard ‚Üí Settings ‚Üí API):

```bash
# Supabase Service Role Key (for seeding only, never commit!)
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

- [ ] Update `.env.example`:

```bash
# Supabase Service Role Key (only needed for seeding scripts)
SUPABASE_SERVICE_ROLE_KEY=
```

#### Step 4: Add NPM Script

- [ ] Add to `package.json`:

```json
{
  "scripts": {
    "seed:education": "tsx scripts/seed-education.ts"
  }
}
```

#### Step 5: Run Seed Script

- [ ] Execute the seeding:

```bash
npm run seed:education
```

Expected output:
```plain text
üöÄ Starting education content seeding...

üìö Loading Open Water content...
Found 5 OW files

üìÑ Processing: Diving Equipment Overview
  ‚úÇÔ∏è  Created 8 chunks
  üß† Generated 8 embeddings
  ‚úÖ Stored 8 chunks with embeddings

üìÑ Processing: Diving Physics Basics
  ‚úÇÔ∏è  Created 6 chunks
  üß† Generated 6 embeddings
  ‚úÖ Stored 6 chunks with embeddings

...

‚ú® Education content seeding complete!
Total documents: 5
Documents in database: 5
```

## Verification Checklist

- [ ] Script created: `scripts/seed-education.ts`
- [ ] Dependencies installed: `gray-matter`, `tsx`
- [ ] Service role key added to `.env.local`
- [ ] NPM script added to `package.json`
- [ ] Seed script runs without errors
- [ ] Documents appear in Supabase `documents` table
- [ ] Chunks with embeddings in `document_chunks` table
- [ ] Vector search test returns relevant results

## Testing

Test vector search after seeding:

```typescript
// In browser console or test file
const response = await fetch('/api/chat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    message: 'What is buoyancy control?'
  })
})

const data = await response.json()
console.log(data.response)
// Should include information from the seeded education content
```

Or test directly in Supabase SQL Editor:

```sql
-- Check documents were inserted
SELECT title, category, subcategory, metadata 
FROM documents 
WHERE category = 'education' 
ORDER BY created_at DESC;

-- Check chunks with embeddings
SELECT 
  dc.content,
  dc.chunk_index,
  d.title
FROM document_chunks dc
JOIN documents d ON dc.document_id = d.id
WHERE d.category = 'education'
LIMIT 5;

-- Test vector search (replace with actual embedding)
SELECT * FROM match_documents(
  '[0.1, 0.2, ...]'::vector(768),
  0.7,
  5,
  'education'
);
```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| `SUPABASE_SERVICE_ROLE_KEY` undefined | Add service role key to `.env.local` from Supabase Dashboard ‚Üí Settings ‚Üí API |
| Rate limit errors from Gemini | Increase sleep time between documents (change `100` to `500` ms) |
| Embeddings dimension mismatch | Verify using `text-embedding-004` model (768 dimensions) |
| Frontmatter parse errors | Check YAML syntax in markdown files; ensure three dashes at start/end |
| `gray-matter` module not found | Run `npm install gray-matter` |
| Database permission errors | Ensure RLS policies allow inserts from service role |
| Duplicate document errors | Clear existing data: `DELETE FROM documents WHERE category = 'education'` |

## Files Modified

- [ ] ‚úÖ Created: `scripts/seed-education.ts`
- [ ] ‚úÖ Modified: `package.json` (added seed script)
- [ ] ‚úÖ Modified: `.env.local` (added service role key)
- [ ] ‚úÖ Modified: `.env.example` (added service role key template)

## What Comes Next

**Next PR:** PR 3.2 - Education Mode & Topic Navigation

Create the learning dashboard UI where users can browse OW/AOW topics, track progress, and launch chat with topic context pre-loaded.
