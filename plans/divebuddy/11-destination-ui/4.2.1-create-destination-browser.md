# Step 4.2.1: Create Destination Browser Page

**Part of:** PR 4.2 - Destination Search & Filtering UI  
**Focus:** Build main destinations browse page with cards and filter sidebar  
**Files to Create:** `/app/destinations/page.tsx`, components for cards and filters  
**Estimated Time:** 45-60 minutes

---

## Pre-Substep Checklist

- [ ] PR 4.1 completed (destinations seeded in database)
- [ ] Branch `4.2-destination-search` created and checked out
- [ ] shadcn/ui components installed (Card, Badge, Select, Checkbox)
- [ ] Development server running

---

## Implementation

### Goal

Create a destination browser page at `/destinations` that displays Malaysian dive sites as cards with filtering capabilities (region, skill level, season, marine life).

### Step-by-Step Instructions

#### 1. Create API Route for Destinations

**File:** `app/api/destinations/route.ts`

```typescript
import { createClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export interface Destination {
  id: string
  name: string
  slug: string
  region: string
  country: string
  skillLevel: string
  visibility: string
  bestMonths: number[]
  marineLife: string[]
  highlights: string[]
  difficulty: string
  preview: string
}

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams
    const region = searchParams.get('region')
    const skillLevel = searchParams.get('skillLevel')
    const month = searchParams.get('month')
    
    const supabase = createClient()
    
    // Query diving_documents for destination metadata
    let query = supabase
      .from('diving_documents')
      .select('metadata, content')
      .eq('category', 'destinations')
      .eq('metadata->>chunk_index', '0') // Only get first chunk of each destination
    
    const { data, error } = await query
    
    if (error) throw error
    
    // Transform and filter results
    let destinations: Destination[] = data.map(doc => ({
      id: doc.metadata.destination_id,
      name: doc.metadata.destination_name,
      slug: doc.metadata.source.split('/')[1],
      region: doc.metadata.region,
      country: doc.metadata.country,
      skillLevel: extractSkillLevel(doc.content),
      visibility: extractVisibility(doc.content),
      bestMonths: extractBestMonths(doc.content),
      marineLife: extractMarineLife(doc.content),
      highlights: extractHighlights(doc.content),
      difficulty: extractDifficulty(doc.content),
      preview: doc.content.substring(0, 200) + '...'
    }))
    
    // Remove duplicates (in case we got multiple chunks somehow)
    destinations = destinations.filter((dest, index, self) =>
      index === self.findIndex(d => d.id === dest.id)
    )
    
    // Apply filters
    if (region && region !== 'all') {
      destinations = destinations.filter(d => d.region.toLowerCase().includes(region.toLowerCase()))
    }
    
    if (skillLevel && skillLevel !== 'all') {
      destinations = destinations.filter(d => 
        d.skillLevel.toLowerCase().includes(skillLevel.toLowerCase())
      )
    }
    
    if (month) {
      const monthNum = parseInt(month)
      destinations = destinations.filter(d => d.bestMonths.includes(monthNum))
    }
    
    return NextResponse.json({ destinations, count: destinations.length })
    
  } catch (error) {
    console.error('Error fetching destinations:', error)
    return NextResponse.json(
      { error: 'Failed to fetch destinations' },
      { status: 500 }
    )
  }
}

// Helper functions to extract data from content
function extractSkillLevel(content: string): string {
  const match = content.match(/skillLevel:\s*(.+)/i) || 
                content.match(/Minimum.*?:\s*(.+?Diver)/i)
  return match ? match[1].trim() : 'Open Water'
}

function extractVisibility(content: string): string {
  const match = content.match(/visibility:\s*(.+)/i) ||
                content.match(/Visibility.*?:\s*(.+?)(?:\n|m)/i)
  return match ? match[1].trim() : 'Variable'
}

function extractBestMonths(content: string): number[] {
  const match = content.match(/bestMonths:\s*\[(.+?)\]/i)
  if (match) {
    return match[1].split(',').map(m => parseInt(m.trim()))
  }
  return [1,2,3,4,5,6,7,8,9,10,11,12]
}

function extractMarineLife(content: string): string[] {
  const match = content.match(/marineLife:\s*\n([\s\S]+?)(?:\n\w+:|highlights:)/i)
  if (match) {
    return match[1].split('\n')
      .filter(line => line.trim().startsWith('-'))
      .map(line => line.replace(/^[\s-]+/, '').trim())
      .slice(0, 5) // Limit to 5
  }
  return []
}

function extractHighlights(content: string): string[] {
  const match = content.match(/highlights:\s*\n([\s\S]+?)(?:\n\w+:|difficulty:)/i)
  if (match) {
    return match[1].split('\n')
      .filter(line => line.trim().startsWith('-'))
      .map(line => line.replace(/^[\s-]+/, '').trim())
      .slice(0, 3)
  }
  return []
}

function extractDifficulty(content: string): string {
  const match = content.match(/difficulty:\s*(.+)/i)
  return match ? match[1].trim() : 'intermediate'
}
```

- [x] Create destinations API route with filtering

#### 2. Create Destination Card Component

**File:** `components/destinations/DestinationCard.tsx`

```typescript
'use client'

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { MapPin, Waves, Eye, Star } from 'lucide-react'

interface DestinationCardProps {
  destination: {
    id: string
    name: string
    slug: string
    region: string
    country: string
    skillLevel: string
    visibility: string
    marineLife: string[]
    highlights: string[]
    difficulty: string
    preview: string
  }
}

export function DestinationCard({ destination }: DestinationCardProps) {
  const difficultyColor = {
    'beginner-friendly': 'bg-green-100 text-green-800',
    'beginner-to-intermediate': 'bg-blue-100 text-blue-800',
    'intermediate': 'bg-yellow-100 text-yellow-800',
    'intermediate-to-advanced': 'bg-orange-100 text-orange-800',
    'advanced': 'bg-red-100 text-red-800'
  }[destination.difficulty] || 'bg-gray-100 text-gray-800'

  return (
    <Card className="hover:shadow-lg transition-shadow">
      <CardHeader>
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <CardTitle className="text-xl">{destination.name}</CardTitle>
            <CardDescription className="flex items-center gap-1 mt-1">
              <MapPin className="w-4 h-4" />
              {destination.region}
            </CardDescription>
          </div>
          <Badge className={difficultyColor}>
            {destination.difficulty.replace('-', ' ')}
          </Badge>
        </div>
      </CardHeader>
      
      <CardContent className="space-y-4">
        {/* Key Info */}
        <div className="grid grid-cols-2 gap-2 text-sm">
          <div className="flex items-center gap-2">
            <Waves className="w-4 h-4 text-blue-500" />
            <span className="text-muted-foreground">Skill:</span>
            <span className="font-medium">{destination.skillLevel}</span>
          </div>
          <div className="flex items-center gap-2">
            <Eye className="w-4 h-4 text-cyan-500" />
            <span className="text-muted-foreground">Vis:</span>
            <span className="font-medium">{destination.visibility}</span>
          </div>
        </div>
        
        {/* Highlights */}
        {destination.highlights.length > 0 && (
          <div>
            <h4 className="text-sm font-semibold mb-2 flex items-center gap-1">
              <Star className="w-4 h-4 text-yellow-500" />
              Highlights
            </h4>
            <ul className="text-sm space-y-1">
              {destination.highlights.slice(0, 3).map((highlight, i) => (
                <li key={i} className="text-muted-foreground flex items-start gap-2">
                  <span className="text-blue-500">â€¢</span>
                  <span>{highlight}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
        
        {/* Marine Life Tags */}
        {destination.marineLife.length > 0 && (
          <div className="flex flex-wrap gap-1">
            {destination.marineLife.slice(0, 4).map((life, i) => (
              <Badge key={i} variant="secondary" className="text-xs">
                {life}
              </Badge>
            ))}
            {destination.marineLife.length > 4 && (
              <Badge variant="secondary" className="text-xs">
                +{destination.marineLife.length - 4} more
              </Badge>
            )}
          </div>
        )}
        
        {/* View Details Button */}
        <Link href={`/destinations/${destination.slug}`} className="block">
          <Button className="w-full" variant="outline">
            View Details
          </Button>
        </Link>
      </CardContent>
    </Card>
  )
}
```

- [x] Create destination card component

#### 3. Create Filter Sidebar Component

**File:** `components/destinations/SearchFilters.tsx`

```typescript
'use client'

import { Label } from '@/components/ui/label'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Filter } from 'lucide-react'

interface SearchFiltersProps {
  filters: {
    region: string
    skillLevel: string
    month: string
  }
  onFilterChange: (key: string, value: string) => void
}

export function SearchFilters({ filters, onFilterChange }: SearchFiltersProps) {
  const months = [
    { value: '', label: 'All Year' },
    { value: '1', label: 'January' },
    { value: '2', label: 'February' },
    { value: '3', label: 'March' },
    { value: '4', label: 'April' },
    { value: '5', label: 'May' },
    { value: '6', label: 'June' },
    { value: '7', label: 'July' },
    { value: '8', label: 'August' },
    { value: '9', label: 'September' },
    { value: '10', label: 'October' },
    { value: '11', label: 'November' },
    { value: '12', label: 'December' },
  ]

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Filter className="w-5 h-5" />
          Filters
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Region Filter */}
        <div className="space-y-2">
          <Label htmlFor="region">Region</Label>
          <Select 
            value={filters.region} 
            onValueChange={(value) => onFilterChange('region', value)}
          >
            <SelectTrigger id="region">
              <SelectValue placeholder="All regions" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Regions</SelectItem>
              <SelectItem value="sabah">Sabah (East Malaysia)</SelectItem>
              <SelectItem value="peninsular">Peninsular Malaysia</SelectItem>
              <SelectItem value="pahang">Pahang</SelectItem>
              <SelectItem value="terengganu">Terengganu</SelectItem>
              <SelectItem value="kedah">Kedah</SelectItem>
            </SelectContent>
          </Select>
        </div>
        
        {/* Skill Level Filter */}
        <div className="space-y-2">
          <Label htmlFor="skillLevel">Skill Level</Label>
          <Select 
            value={filters.skillLevel} 
            onValueChange={(value) => onFilterChange('skillLevel', value)}
          >
            <SelectTrigger id="skillLevel">
              <SelectValue placeholder="All levels" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Levels</SelectItem>
              <SelectItem value="open water">Open Water</SelectItem>
              <SelectItem value="advanced">Advanced Open Water</SelectItem>
              <SelectItem value="beginner">Beginner Friendly</SelectItem>
            </SelectContent>
          </Select>
        </div>
        
        {/* Best Month Filter */}
        <div className="space-y-2">
          <Label htmlFor="month">Best Time to Visit</Label>
          <Select 
            value={filters.month} 
            onValueChange={(value) => onFilterChange('month', value)}
          >
            <SelectTrigger id="month">
              <SelectValue placeholder="Any month" />
            </SelectTrigger>
            <SelectContent>
              {months.map(month => (
                <SelectItem key={month.value} value={month.value}>
                  {month.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </CardContent>
    </Card>
  )
}
```

- [x] Create filter sidebar component

#### 4. Create Destinations Browse Page

**File:** `app/destinations/page.tsx`

```typescript
'use client'

import { useState, useEffect } from 'react'
import { DestinationCard } from '@/components/destinations/DestinationCard'
import { SearchFilters } from '@/components/destinations/SearchFilters'
import { Skeleton } from '@/components/ui/skeleton'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { MapPin, AlertCircle } from 'lucide-react'

interface Destination {
  id: string
  name: string
  slug: string
  region: string
  country: string
  skillLevel: string
  visibility: string
  marineLife: string[]
  highlights: string[]
  difficulty: string
  preview: string
}

export default function DestinationsPage() {
  const [destinations, setDestinations] = useState<Destination[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [filters, setFilters] = useState({
    region: 'all',
    skillLevel: 'all',
    month: ''
  })

  useEffect(() => {
    fetchDestinations()
  }, [filters])

  async function fetchDestinations() {
    setLoading(true)
    setError(null)
    
    try {
      const params = new URLSearchParams()
      if (filters.region !== 'all') params.append('region', filters.region)
      if (filters.skillLevel !== 'all') params.append('skillLevel', filters.skillLevel)
      if (filters.month) params.append('month', filters.month)
      
      const response = await fetch(`/api/destinations?${params.toString()}`)
      
      if (!response.ok) throw new Error('Failed to fetch destinations')
      
      const data = await response.json()
      setDestinations(data.destinations)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred')
    } finally {
      setLoading(false)
    }
  }

  function handleFilterChange(key: string, value: string) {
    setFilters(prev => ({ ...prev, [key]: value }))
  }

  return (
    <div className="container mx-auto px-4 py-8">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-4xl font-bold flex items-center gap-2">
          <MapPin className="w-8 h-8 text-blue-600" />
          Dive Destinations
        </h1>
        <p className="text-muted-foreground mt-2">
          Explore the best dive sites across Malaysia
        </p>
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
        {/* Sidebar Filters */}
        <aside className="lg:col-span-1">
          <SearchFilters filters={filters} onFilterChange={handleFilterChange} />
        </aside>

        {/* Destinations Grid */}
        <main className="lg:col-span-3">
          {/* Results Count */}
          {!loading && !error && (
            <div className="mb-4 text-sm text-muted-foreground">
              Found {destinations.length} destination{destinations.length !== 1 ? 's' : ''}
            </div>
          )}

          {/* Error State */}
          {error && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          {/* Loading State */}
          {loading && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {[1, 2, 3, 4].map(i => (
                <div key={i} className="space-y-4">
                  <Skeleton className="h-48 w-full" />
                  <Skeleton className="h-4 w-3/4" />
                  <Skeleton className="h-4 w-1/2" />
                </div>
              ))}
            </div>
          )}

          {/* Destinations Grid */}
          {!loading && !error && destinations.length > 0 && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {destinations.map(destination => (
                <DestinationCard key={destination.id} destination={destination} />
              ))}
            </div>
          )}

          {/* Empty State */}
          {!loading && !error && destinations.length === 0 && (
            <div className="text-center py-12">
              <MapPin className="w-16 h-16 mx-auto text-muted-foreground mb-4" />
              <h3 className="text-lg font-semibold mb-2">No destinations found</h3>
              <p className="text-muted-foreground">
                Try adjusting your filters to see more results
              </p>
            </div>
          )}
        </main>
      </div>
    </div>
  )
}
```

- [x] Create destinations browse page

---

## Verification Checklist

### Functionality
- [ ] Navigate to `/destinations` - page loads without errors
- [ ] Destination cards display correctly with all information
- [ ] Filters work:
  - Region filter narrows results appropriately
  - Skill level filter shows correct destinations
  - Month filter shows destinations good for that month
- [ ] Cards show marine life badges and highlights
- [ ] "View Details" button links to correct destination page (will create next)

### UI/UX
- [ ] Page is responsive (mobile, tablet, desktop)
- [ ] Loading skeletons display while fetching
- [ ] Error states show user-friendly messages
- [ ] Filter sidebar is accessible and clear
- [ ] Cards have hover effects

### Data Quality
- [ ] All Malaysian destinations appear
- [ ] Metadata extracted correctly from content
- [ ] No duplicate destinations shown
- [ ] Marine life and highlights display correctly

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| **No destinations appear** | Check API route is returning data; verify diving_documents table has destinations |
| **Filters not working** | Check query parameter construction in fetchDestinations function |
| **Duplicate destinations** | Ensure filter by chunk_index=0 in API route |
| **Styling broken** | Verify shadcn/ui components installed: `npx shadcn-ui@latest add card badge select` |
| **Extract functions return wrong data** | Adjust regex patterns in API route helper functions |

---

## Files Modified

### Created
- `app/api/destinations/route.ts` - Destinations API with filtering
- `app/destinations/page.tsx` - Main browse page
- `components/destinations/DestinationCard.tsx` - Destination card component
- `components/destinations/SearchFilters.tsx` - Filter sidebar

---

## What Comes Next

**Next Step:** 4.2.2 - Create Destination Detail Pages

Build individual destination pages at `/destinations/[slug]` that show complete information including all dive sites, getting there instructions, best times, and more.
