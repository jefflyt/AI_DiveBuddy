# Step 3.3.2: Create Quiz Progress Database Schema

**Part of:** PR 3.3 - Quiz System & Knowledge Validation  
**Focus:** Database tables for quiz attempts and scoring  
**Files to Create:** Migration SQL for `quiz_attempts` and `quiz_answers`  
**Estimated Time:** 15 minutes

## Overview

Design and implement database schema to track quiz attempts, individual answers, scores, and historical performance. This enables progress tracking and analytics.

## Pre-Substep Checklist

- [ ] **Completed:** Step 3.3.1 - Quiz UI components
- [ ] **Supabase:** Project created with database access
- [ ] **Existing tables:** `user_progress` table already exists
- [ ] **Migration tool:** Supabase SQL Editor available

## Implementation

### Goal

Create normalized database tables that store quiz attempts with detailed answer tracking and scoring history.

### Step-by-Step Instructions

#### Step 1: Create Quiz Attempts Table

- [ ] Run in Supabase SQL Editor:

```sql
-- Quiz Attempts Table
CREATE TABLE IF NOT EXISTS quiz_attempts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  topic_id TEXT NOT NULL,
  certification TEXT NOT NULL CHECK (certification IN ('OW', 'AOW')),
  score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
  total_questions INTEGER NOT NULL,
  correct_answers INTEGER NOT NULL,
  passed BOOLEAN NOT NULL DEFAULT FALSE,
  time_spent_seconds INTEGER,
  completed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_quiz_attempts_user_id ON quiz_attempts(user_id);
CREATE INDEX idx_quiz_attempts_topic_id ON quiz_attempts(topic_id);
CREATE INDEX idx_quiz_attempts_user_topic ON quiz_attempts(user_id, topic_id);
CREATE INDEX idx_quiz_attempts_completed ON quiz_attempts(completed_at DESC);

-- RLS Policies
ALTER TABLE quiz_attempts ENABLE ROW LEVEL SECURITY;

-- Users can view their own quiz attempts
CREATE POLICY "Users can view own quiz attempts"
  ON quiz_attempts
  FOR SELECT
  USING (auth.uid() = user_id);

-- Users can insert their own quiz attempts
CREATE POLICY "Users can insert own quiz attempts"
  ON quiz_attempts
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Users can update their own quiz attempts (for time tracking)
CREATE POLICY "Users can update own quiz attempts"
  ON quiz_attempts
  FOR UPDATE
  USING (auth.uid() = user_id);
```

#### Step 2: Create Quiz Answers Table

- [ ] Run in Supabase SQL Editor:

```sql
-- Quiz Answers Table (detailed answer tracking)
CREATE TABLE IF NOT EXISTS quiz_answers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  attempt_id UUID NOT NULL REFERENCES quiz_attempts(id) ON DELETE CASCADE,
  question_id TEXT NOT NULL,
  question_text TEXT NOT NULL,
  selected_answer INTEGER NOT NULL,
  correct_answer INTEGER NOT NULL,
  is_correct BOOLEAN NOT NULL,
  explanation TEXT,
  answered_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_quiz_answers_attempt_id ON quiz_answers(attempt_id);
CREATE INDEX idx_quiz_answers_question_id ON quiz_answers(question_id);

-- RLS Policies
ALTER TABLE quiz_answers ENABLE ROW LEVEL SECURITY;

-- Users can view answers for their own attempts
CREATE POLICY "Users can view own quiz answers"
  ON quiz_answers
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM quiz_attempts
      WHERE quiz_attempts.id = quiz_answers.attempt_id
        AND quiz_attempts.user_id = auth.uid()
    )
  );

-- Users can insert answers for their own attempts
CREATE POLICY "Users can insert own quiz answers"
  ON quiz_answers
  FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM quiz_attempts
      WHERE quiz_attempts.id = quiz_answers.attempt_id
        AND quiz_attempts.user_id = auth.uid()
    )
  );
```

#### Step 3: Create Helper Functions

- [ ] Create function to get quiz statistics:

```sql
-- Function to get user's quiz statistics for a topic
CREATE OR REPLACE FUNCTION get_topic_quiz_stats(
  p_user_id UUID,
  p_topic_id TEXT
)
RETURNS TABLE (
  total_attempts INTEGER,
  best_score INTEGER,
  average_score NUMERIC,
  passed_count INTEGER,
  last_attempt_date TIMESTAMP WITH TIME ZONE
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::INTEGER AS total_attempts,
    MAX(score)::INTEGER AS best_score,
    ROUND(AVG(score), 1) AS average_score,
    COUNT(*) FILTER (WHERE passed = true)::INTEGER AS passed_count,
    MAX(completed_at) AS last_attempt_date
  FROM quiz_attempts
  WHERE user_id = p_user_id
    AND topic_id = p_topic_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

- [ ] Create function to get recent quiz attempts:

```sql
-- Function to get user's recent quiz attempts
CREATE OR REPLACE FUNCTION get_recent_quiz_attempts(
  p_user_id UUID,
  p_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
  id UUID,
  topic_id TEXT,
  certification TEXT,
  score INTEGER,
  passed BOOLEAN,
  completed_at TIMESTAMP WITH TIME ZONE
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    qa.id,
    qa.topic_id,
    qa.certification,
    qa.score,
    qa.passed,
    qa.completed_at
  FROM quiz_attempts qa
  WHERE qa.user_id = p_user_id
  ORDER BY qa.completed_at DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### Step 4: Create View for Quiz Leaderboard (Optional)

- [ ] Create leaderboard view:

```sql
-- View for topic leaderboard (best scores)
CREATE OR REPLACE VIEW quiz_leaderboard AS
SELECT
  qa.topic_id,
  qa.certification,
  u.email AS user_email,
  qa.score,
  qa.completed_at,
  ROW_NUMBER() OVER (
    PARTITION BY qa.topic_id
    ORDER BY qa.score DESC, qa.completed_at ASC
  ) AS rank
FROM quiz_attempts qa
JOIN auth.users u ON qa.user_id = u.id
WHERE qa.passed = true;

-- Grant access
GRANT SELECT ON quiz_leaderboard TO authenticated;
```

#### Step 5: Verify Schema

- [ ] Check tables created successfully:

```sql
-- List all quiz-related tables
SELECT table_name, table_type
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name LIKE 'quiz_%';

-- Check RLS policies
SELECT tablename, policyname, permissive, roles, cmd
FROM pg_policies
WHERE tablename IN ('quiz_attempts', 'quiz_answers');
```

## Verification Checklist

- [ ] Table created: `quiz_attempts`
- [ ] Table created: `quiz_answers`
- [ ] Indexes created on both tables
- [ ] RLS policies enabled and configured
- [ ] Helper functions created: `get_topic_quiz_stats`, `get_recent_quiz_attempts`
- [ ] Optional leaderboard view created
- [ ] All policies tested with authenticated user
- [ ] Foreign key constraints working

## Testing

Test the schema with sample data:

```sql
-- Insert test quiz attempt (replace UUIDs with your user_id)
INSERT INTO quiz_attempts (
  user_id,
  topic_id,
  certification,
  score,
  total_questions,
  correct_answers,
  passed
) VALUES (
  'your-user-id-here',
  'ow-equipment-overview',
  'OW',
  80,
  5,
  4,
  true
) RETURNING *;

-- Get the attempt_id from above, then insert answers
INSERT INTO quiz_answers (
  attempt_id,
  question_id,
  question_text,
  selected_answer,
  correct_answer,
  is_correct,
  explanation
) VALUES
  ('attempt-id-here', 'q1', 'What is the max depth?', 1, 1, true, 'OW max is 18m'),
  ('attempt-id-here', 'q2', 'What does BCD mean?', 0, 0, true, 'Buoyancy Control Device'),
  ('attempt-id-here', 'q3', 'How often equalize?', 2, 1, false, 'Should be every 1-2m');

-- Test statistics function
SELECT * FROM get_topic_quiz_stats(
  'your-user-id-here',
  'ow-equipment-overview'
);
-- Should return: total_attempts=1, best_score=80, average_score=80, passed_count=1

-- Test recent attempts function
SELECT * FROM get_recent_quiz_attempts('your-user-id-here', 5);

-- Test leaderboard view
SELECT * FROM quiz_leaderboard
WHERE topic_id = 'ow-equipment-overview'
LIMIT 10;
```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| RLS blocking inserts | Verify `auth.uid()` matches `user_id` in INSERT; check policy conditions |
| Foreign key violation | Ensure `user_id` exists in `auth.users` table; use valid UUID |
| Function not found | Check function created with `SECURITY DEFINER` flag |
| Indexes not improving queries | Run `EXPLAIN ANALYZE` on queries; verify index usage in query plan |
| Leaderboard view empty | Insert quiz attempts with `passed = true`; check JOIN conditions |
| Cascade delete not working | Verify `ON DELETE CASCADE` in foreign key definition |
| Timestamp timezone issues | Always use `TIMESTAMP WITH TIME ZONE` for consistency |

## Files Modified

- [ ] ✅ Created: Migration SQL (run in Supabase SQL Editor)
- [ ] ✅ Tables: `quiz_attempts`, `quiz_answers`
- [ ] ✅ Functions: `get_topic_quiz_stats`, `get_recent_quiz_attempts`
- [ ] ✅ View: `quiz_leaderboard`

## What Comes Next

**Next Substep:** 3.3.3 - Create Quiz API Routes

Build Next.js API endpoints to handle quiz submissions, score calculations, and progress tracking.
