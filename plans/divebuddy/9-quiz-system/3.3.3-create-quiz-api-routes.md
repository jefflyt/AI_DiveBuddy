# Step 3.3.3: Create Quiz API Routes

**Part of:** PR 3.3 - Quiz System & Knowledge Validation  
**Focus:** API endpoints for quiz submission and progress tracking  
**Files to Create:** `app/api/quiz/submit/route.ts`, `app/api/quiz/stats/[topicId]/route.ts`  
**Estimated Time:** 20 minutes

## Overview

Build Next.js API routes that handle quiz submissions, calculate scores, store results in the database, and update user progress when quizzes are passed.

## Pre-Substep Checklist

- [ ] **Completed:** Step 3.3.2 - Quiz database schema created
- [ ] **Tables exist:** `quiz_attempts`, `quiz_answers` in Supabase
- [ ] **Auth working:** Supabase authentication configured
- [ ] **Helper functions:** `get_topic_quiz_stats` available

## Implementation

### Goal

Create secure, edge-compatible API routes that process quiz submissions and provide statistics.

### Step-by-Step Instructions

#### Step 1: Create Quiz Submission Route

- [ ] Create `app/api/quiz/submit/route.ts`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export const runtime = 'edge'

interface QuizSubmission {
  topicId: string
  certification: 'OW' | 'AOW'
  answers: Array<{
    questionId: string
    questionText: string
    selectedAnswer: number
    correctAnswer: number
    explanation: string
  }>
  timeSpentSeconds?: number
}

export async function POST(req: NextRequest) {
  try {
    const supabase = createServerClient()

    // Check authentication
    const {
      data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const body: QuizSubmission = await req.json()
    const { topicId, certification, answers, timeSpentSeconds } = body

    // Validate input
    if (!topicId || !certification || !answers || answers.length === 0) {
      return NextResponse.json(
        { error: 'Missing required fields' },
        { status: 400 }
      )
    }

    // Calculate score
    const totalQuestions = answers.length
    const correctAnswers = answers.filter(
      (a) => a.selectedAnswer === a.correctAnswer
    ).length
    const score = Math.round((correctAnswers / totalQuestions) * 100)
    const passed = score >= 70

    // Insert quiz attempt
    const { data: attempt, error: attemptError } = await supabase
      .from('quiz_attempts')
      .insert({
        user_id: user.id,
        topic_id: topicId,
        certification,
        score,
        total_questions: totalQuestions,
        correct_answers: correctAnswers,
        passed,
        time_spent_seconds: timeSpentSeconds || null,
      })
      .select()
      .single()

    if (attemptError) {
      console.error('Error creating quiz attempt:', attemptError)
      return NextResponse.json(
        { error: 'Failed to save quiz attempt' },
        { status: 500 }
      )
    }

    // Insert individual answers
    const answerRecords = answers.map((a) => ({
      attempt_id: attempt.id,
      question_id: a.questionId,
      question_text: a.questionText,
      selected_answer: a.selectedAnswer,
      correct_answer: a.correctAnswer,
      is_correct: a.selectedAnswer === a.correctAnswer,
      explanation: a.explanation,
    }))

    const { error: answersError } = await supabase
      .from('quiz_answers')
      .insert(answerRecords)

    if (answersError) {
      console.error('Error saving quiz answers:', answersError)
      // Continue even if answers fail to save
    }

    // If passed, update user_progress
    if (passed) {
      const { error: progressError } = await supabase
        .from('user_progress')
        .upsert({
          user_id: user.id,
          topic_id: topicId,
          certification,
          completed: true,
          completed_at: new Date().toISOString(),
        })

      if (progressError) {
        console.error('Error updating user progress:', progressError)
      }
    }

    return NextResponse.json({
      success: true,
      attemptId: attempt.id,
      score,
      passed,
      correctAnswers,
      totalQuestions,
    })
  } catch (error) {
    console.error('Quiz submission error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

#### Step 2: Create Quiz Statistics Route

- [ ] Create `app/api/quiz/stats/[topicId]/route.ts`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export const runtime = 'edge'

export async function GET(
  req: NextRequest,
  { params }: { params: { topicId: string } }
) {
  try {
    const supabase = createServerClient()

    const {
      data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { topicId } = params

    // Get quiz statistics using helper function
    const { data: stats, error: statsError } = await supabase.rpc(
      'get_topic_quiz_stats',
      {
        p_user_id: user.id,
        p_topic_id: topicId,
      }
    )

    if (statsError) {
      console.error('Error fetching quiz stats:', statsError)
      return NextResponse.json(
        { error: 'Failed to fetch statistics' },
        { status: 500 }
      )
    }

    // Get recent attempts for this topic
    const { data: attempts, error: attemptsError } = await supabase
      .from('quiz_attempts')
      .select('id, score, passed, completed_at')
      .eq('user_id', user.id)
      .eq('topic_id', topicId)
      .order('completed_at', { ascending: false })
      .limit(5)

    if (attemptsError) {
      console.error('Error fetching quiz attempts:', attemptsError)
    }

    const statsData = stats?.[0] || {
      total_attempts: 0,
      best_score: 0,
      average_score: 0,
      passed_count: 0,
      last_attempt_date: null,
    }

    return NextResponse.json({
      topicId,
      totalAttempts: statsData.total_attempts,
      bestScore: statsData.best_score,
      averageScore: parseFloat(statsData.average_score || '0'),
      passedCount: statsData.passed_count,
      lastAttemptDate: statsData.last_attempt_date,
      recentAttempts: attempts || [],
    })
  } catch (error) {
    console.error('Quiz stats error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

#### Step 3: Create Quiz Attempt Detail Route

- [ ] Create `app/api/quiz/attempts/[attemptId]/route.ts`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export const runtime = 'edge'

export async function GET(
  req: NextRequest,
  { params }: { params: { attemptId: string } }
) {
  try {
    const supabase = createServerClient()

    const {
      data: { user },
    } = await supabase.auth.getUser()

    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { attemptId } = params

    // Get quiz attempt
    const { data: attempt, error: attemptError } = await supabase
      .from('quiz_attempts')
      .select('*')
      .eq('id', attemptId)
      .eq('user_id', user.id)
      .single()

    if (attemptError || !attempt) {
      return NextResponse.json(
        { error: 'Quiz attempt not found' },
        { status: 404 }
      )
    }

    // Get all answers for this attempt
    const { data: answers, error: answersError } = await supabase
      .from('quiz_answers')
      .select('*')
      .eq('attempt_id', attemptId)
      .order('answered_at', { ascending: true })

    if (answersError) {
      console.error('Error fetching quiz answers:', answersError)
    }

    return NextResponse.json({
      attempt,
      answers: answers || [],
    })
  } catch (error) {
    console.error('Quiz attempt detail error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

#### Step 4: Update Quiz Component to Use API

- [ ] Modify `components/quiz/Quiz.tsx` to submit to API:

```typescript
'use client'

import { useState } from 'react'
import { QuizQuestion, QuizQuestionData } from './QuizQuestion'
import { QuizResults } from './QuizResults'
import { Button } from '@/components/ui/button'
import { Progress } from '@/components/ui/progress'
import { ChevronRight } from 'lucide-react'

interface QuizProps {
  questions: QuizQuestionData[]
  topicId: string
  certification: 'OW' | 'AOW'
  onComplete: () => void
}

interface AnswerRecord {
  questionId: string
  questionText: string
  selectedAnswer: number
  correctAnswer: number
  isCorrect: boolean
  explanation: string
}

export function Quiz({ questions, topicId, certification, onComplete }: QuizProps) {
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0)
  const [answers, setAnswers] = useState<AnswerRecord[]>([])
  const [showResults, setShowResults] = useState(false)
  const [startTime] = useState(Date.now())
  const [isSubmitting, setIsSubmitting] = useState(false)

  const currentQuestion = questions[currentQuestionIndex]
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100

  const handleAnswer = (questionId: string, selectedAnswer: number, isCorrect: boolean) => {
    const question = questions.find((q) => q.id === questionId)!

    setAnswers([
      ...answers,
      {
        questionId,
        questionText: question.question,
        selectedAnswer,
        correctAnswer: question.correctAnswer,
        isCorrect,
        explanation: question.explanation,
      },
    ])
  }

  const handleNext = async () => {
    if (currentQuestionIndex < questions.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1)
    } else {
      // Submit quiz to API
      await submitQuiz()
    }
  }

  const submitQuiz = async () => {
    setIsSubmitting(true)

    const timeSpentSeconds = Math.floor((Date.now() - startTime) / 1000)

    try {
      const response = await fetch('/api/quiz/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          topicId,
          certification,
          answers,
          timeSpentSeconds,
        }),
      })

      if (!response.ok) {
        throw new Error('Failed to submit quiz')
      }

      setShowResults(true)
    } catch (error) {
      console.error('Quiz submission error:', error)
      alert('Failed to submit quiz. Please try again.')
    } finally {
      setIsSubmitting(false)
    }
  }

  const handleRetake = () => {
    setCurrentQuestionIndex(0)
    setAnswers([])
    setShowResults(false)
  }

  const correctCount = answers.filter((a) => a.isCorrect).length

  if (showResults) {
    return (
      <QuizResults
        totalQuestions={questions.length}
        correctAnswers={correctCount}
        onRetake={handleRetake}
        onComplete={onComplete}
      />
    )
  }

  const hasAnswered = answers.some((a) => a.questionId === currentQuestion.id)

  return (
    <div className="space-y-6">
      <div className="space-y-2">
        <div className="flex justify-between text-sm">
          <span className="font-medium">Quiz Progress</span>
          <span className="text-muted-foreground">
            {currentQuestionIndex + 1} of {questions.length}
          </span>
        </div>
        <Progress value={progress} className="h-2" />
      </div>

      <QuizQuestion
        data={currentQuestion}
        questionNumber={currentQuestionIndex + 1}
        onAnswer={handleAnswer}
        answered={hasAnswered}
      />

      {hasAnswered && (
        <div className="flex justify-end">
          <Button
            onClick={handleNext}
            size="lg"
            disabled={isSubmitting}
          >
            {isSubmitting ? (
              'Submitting...'
            ) : currentQuestionIndex < questions.length - 1 ? (
              <>
                Next Question
                <ChevronRight className="w-4 h-4 ml-2" />
              </>
            ) : (
              'View Results'
            )}
          </Button>
        </div>
      )}
    </div>
  )
}
```

## Verification Checklist

- [ ] Route created: `app/api/quiz/submit/route.ts`
- [ ] Route created: `app/api/quiz/stats/[topicId]/route.ts`
- [ ] Route created: `app/api/quiz/attempts/[attemptId]/route.ts`
- [ ] Quiz component updated to call submit API
- [ ] API handles authentication correctly
- [ ] Quiz submissions stored in database
- [ ] User progress updated when passed
- [ ] Statistics endpoint returns correct data
- [ ] Error handling implemented

## Testing

1. **Test quiz submission:**
   - Complete a quiz in the UI
   - Check Supabase tables for new records:
   ```sql
   SELECT * FROM quiz_attempts ORDER BY created_at DESC LIMIT 1;
   SELECT * FROM quiz_answers WHERE attempt_id = 'attempt-id-here';
   ```

2. **Test statistics API:**
   ```bash
   curl http://localhost:3000/api/quiz/stats/ow-equipment-overview \
     -H "Cookie: your-auth-cookie"
   ```

3. **Test progress update:**
   - Pass a quiz (70%+)
   - Check `user_progress` table:
   ```sql
   SELECT * FROM user_progress WHERE topic_id = 'ow-equipment-overview';
   ```

4. **Test attempt detail:**
   ```bash
   curl http://localhost:3000/api/quiz/attempts/{attempt-id} \
     -H "Cookie: your-auth-cookie"
   ```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| 401 Unauthorized | Check Supabase auth cookie is present; verify `auth.getUser()` returns user |
| Quiz not submitting | Check browser console for errors; verify API route path is correct |
| Database insert fails | Check RLS policies allow authenticated users to insert; verify user_id matches |
| Progress not updating | Check `passed` calculation (>= 70%); verify upsert logic in submit route |
| Stats returning null | Ensure `get_topic_quiz_stats` function exists and is callable |
| TypeScript errors | Verify `QuizSubmission` interface matches request body |
| Edge runtime errors | Remove Node.js-specific APIs; use only edge-compatible code |

## Files Modified

- [ ] ✅ Created: `app/api/quiz/submit/route.ts`
- [ ] ✅ Created: `app/api/quiz/stats/[topicId]/route.ts`
- [ ] ✅ Created: `app/api/quiz/attempts/[attemptId]/route.ts`
- [ ] ✅ Modified: `components/quiz/Quiz.tsx` (added API submission)

## What Comes Next

**Next Substep:** 3.3.4 - Integrate Quizzes with Topic Pages

Embed quiz components into education topic detail pages and connect them with the quiz API.
