# Step 3.3.4: Integrate Quizzes with Topic Pages

**Part of:** PR 3.3 - Quiz System & Knowledge Validation  
**Focus:** Embed quiz components into education topic detail pages  
**Files to Modify:** `app/learn/[certification]/[topic]/page.tsx`  
**Estimated Time:** 15 minutes

## Overview

Add quiz components to the bottom of topic detail pages, loading quiz questions from topic metadata and connecting them with the quiz submission API.

## Pre-Substep Checklist

- [ ] **Completed:** Step 3.3.3 - Quiz API routes functional
- [ ] **Components ready:** Quiz, QuizQuestion, QuizResults created
- [ ] **Content has quizzes:** Topic markdown includes quiz questions in frontmatter
- [ ] **Database:** Quiz tables and RLS policies configured

## Implementation

### Goal

Display topic quizzes after reading content, submit answers to API, and update progress on completion.

### Step-by-Step Instructions

#### Step 1: Update Topic Page to Include Quiz

- [ ] Modify `app/learn/[certification]/[topic]/page.tsx`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { redirect, notFound } from 'next/navigation'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import { ArrowLeft, MessageSquare, CheckCircle2 } from 'lucide-react'
import Link from 'next/link'
import ReactMarkdown from 'react-markdown'
import { Quiz } from '@/components/quiz/Quiz'
import { revalidatePath } from 'next/cache'

interface PageProps {
  params: {
    certification: string
    topic: string
  }
}

async function getTopic(topicId: string, certification: string) {
  const supabase = createServerClient()

  const { data: document, error } = await supabase
    .from('documents')
    .select('*')
    .eq('category', 'education')
    .eq('subcategory', certification.toUpperCase())
    .eq('metadata->>id', topicId)
    .single()

  if (error || !document) {
    return null
  }

  return document
}

export default async function TopicPage({ params }: PageProps) {
  const { certification, topic } = params

  if (!['ow', 'aow'].includes(certification)) {
    notFound()
  }

  const supabase = createServerClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect(`/auth/login?redirect=/learn/${certification}/${topic}`)
  }

  const document = await getTopic(topic, certification)

  if (!document) {
    notFound()
  }

  // Check if user completed this topic
  const { data: progress } = await supabase
    .from('user_progress')
    .select('completed')
    .eq('user_id', user.id)
    .eq('topic_id', topic)
    .single()

  const isCompleted = progress?.completed || false

  // Extract quiz questions from metadata
  const quizQuestions = document.metadata?.quiz || []
  const hasQuiz = quizQuestions.length > 0

  // Handle quiz completion
  async function handleQuizComplete() {
    'use server'

    const supabase = createServerClient()
    const {
      data: { user },
    } = await supabase.auth.getUser()

    if (user) {
      await supabase.from('user_progress').upsert({
        user_id: user.id,
        topic_id: topic,
        certification: certification.toUpperCase(),
        completed: true,
        completed_at: new Date().toISOString(),
      })

      revalidatePath(`/learn/${certification}/${topic}`)
      revalidatePath(`/learn/${certification}`)
      redirect(`/learn/${certification}`)
    }
  }

  return (
    <div className="min-h-screen bg-white">
      {/* Header */}
      <div className="border-b sticky top-0 bg-white z-10">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <Link
              href={`/learn/${certification}`}
              className="inline-flex items-center text-sm text-muted-foreground hover:text-foreground"
            >
              <ArrowLeft className="w-4 h-4 mr-1" />
              Back to {certification.toUpperCase()} Topics
            </Link>

            <div className="flex items-center gap-3">
              <Button asChild variant="outline" size="sm">
                <Link href={`/chat?context=education&topic=${topic}`}>
                  <MessageSquare className="w-4 h-4 mr-2" />
                  Ask AI Tutor
                </Link>
              </Button>

              {isCompleted && (
                <Badge variant="outline" className="bg-green-50 text-green-700 border-green-200">
                  <CheckCircle2 className="w-3 h-3 mr-1" />
                  Completed
                </Badge>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Content */}
      <article className="container mx-auto px-4 py-8 max-w-4xl">
        {/* Title & Metadata */}
        <div className="mb-8">
          <div className="flex flex-wrap gap-2 mb-4">
            <Badge variant="outline">{document.metadata?.module}</Badge>
            <Badge variant="outline" className="capitalize">
              {document.metadata?.difficulty}
            </Badge>
            <Badge variant="secondary">{document.metadata?.estimatedReadTime}</Badge>
          </div>

          <h1 className="text-4xl font-bold mb-4">{document.title}</h1>

          {document.metadata?.tags && (
            <div className="flex flex-wrap gap-2">
              {document.metadata.tags.map((tag: string) => (
                <Badge key={tag} variant="secondary" className="text-xs">
                  {tag}
                </Badge>
              ))}
            </div>
          )}
        </div>

        <Separator className="my-8" />

        {/* Markdown Content */}
        <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-h2:text-2xl prose-h3:text-xl prose-p:text-base prose-p:leading-relaxed prose-li:text-base prose-strong:text-blue-700 prose-a:text-blue-600">
          <ReactMarkdown>{document.content}</ReactMarkdown>
        </div>

        {/* Quiz Section */}
        {hasQuiz && (
          <>
            <Separator className="my-12" />

            <div className="space-y-6">
              <div>
                <h2 className="text-3xl font-bold mb-2">Test Your Knowledge</h2>
                <p className="text-muted-foreground">
                  Complete this quiz to validate your understanding and mark this topic as complete.
                  You need 70% or higher to pass.
                </p>
              </div>

              <Quiz
                questions={quizQuestions}
                topicId={topic}
                certification={certification.toUpperCase() as 'OW' | 'AOW'}
                onComplete={handleQuizComplete}
              />
            </div>
          </>
        )}

        {/* No Quiz - Manual Completion */}
        {!hasQuiz && !isCompleted && (
          <>
            <Separator className="my-8" />
            <div className="flex items-center justify-center">
              <form action={handleQuizComplete}>
                <Button type="submit" size="lg">
                  <CheckCircle2 className="w-4 h-4 mr-2" />
                  Mark as Complete
                </Button>
              </form>
            </div>
          </>
        )}

        {/* Discussion CTA */}
        <Separator className="my-8" />
        <div className="text-center p-6 bg-blue-50 rounded-lg">
          <h3 className="font-semibold mb-2">Have Questions?</h3>
          <p className="text-sm text-muted-foreground mb-4">
            Chat with your AI tutor to clarify concepts and get personalized explanations.
          </p>
          <Button asChild variant="outline">
            <Link href={`/chat?context=education&topic=${topic}`}>
              <MessageSquare className="w-4 h-4 mr-2" />
              Start Discussion
            </Link>
          </Button>
        </div>
      </article>
    </div>
  )
}
```

#### Step 2: Update Content Structure for Quiz Questions

- [ ] Ensure topic markdown includes quiz in frontmatter (example from 3.1.2):

```yaml
---
id: ow-equipment-overview
title: Diving Equipment Overview
module: Module 1
certification: OW
difficulty: beginner
estimatedReadTime: 12 min
tags: [equipment, safety, beginner]
version: 1.0
lastUpdated: 2025-11-26
quiz:
  - id: q1
    question: "What is the primary function of a BCD?"
    options:
      - "To help you breathe underwater"
      - "To control buoyancy by adding or releasing air"
      - "To measure depth and dive time"
      - "To protect you from cold water"
    correctAnswer: 1
    explanation: "The Buoyancy Control Device (BCD) allows divers to achieve neutral buoyancy by adjusting the air in the bladder."
  - id: q2
    question: "At what depth should you start equalizing your ears?"
    options:
      - "At the surface before descent"
      - "Every 1-2 meters during descent"
      - "Only when you feel pressure"
      - "At maximum depth"
    correctAnswer: 1
    explanation: "You should equalize early and often, ideally every 1-2 meters (3-6 feet) during descent to prevent ear barotrauma."
  - id: q3
    question: "Which piece of equipment is NOT part of the basic scuba unit?"
    options:
      - "Regulator"
      - "Tank"
      - "Dive computer"
      - "BCD"
    correctAnswer: 2
    explanation: "While highly recommended, a dive computer is not part of the basic scuba unit (which includes tank, BCD, and regulator)."
---
```

#### Step 3: Install Tailwind Typography Plugin (if not already)

- [ ] Install for proper markdown prose styling:

```bash
npm install -D @tailwindcss/typography
```

- [ ] Add to `tailwind.config.js`:

```javascript
module.exports = {
  plugins: [
    require('@tailwindcss/typography'),
  ],
}
```

## Verification Checklist

- [ ] Quiz component renders at bottom of topic page
- [ ] Quiz questions loaded from topic metadata
- [ ] Markdown content displays with proper styling
- [ ] "Mark as Complete" button shows when no quiz present
- [ ] Quiz submission updates user progress
- [ ] Completed badge appears after passing quiz
- [ ] Page redirects to certification browse after completion
- [ ] "Ask AI Tutor" button links to contextual chat

## Testing

1. **View topic with quiz:**
   ```
   http://localhost:3000/learn/ow/ow-equipment-overview
   ```
   - Should display content + quiz at bottom
   - Quiz should have 3 questions

2. **Complete quiz:**
   - Answer all questions
   - Click "View Results"
   - Pass with 70%+ → should show "Complete Topic" button
   - Click button → redirects to `/learn/ow`
   - Check topic card shows completed checkmark

3. **View topic without quiz:**
   - Create topic with no quiz metadata
   - Should show "Mark as Complete" button at bottom

4. **Test progress tracking:**
   ```sql
   SELECT * FROM user_progress WHERE topic_id = 'ow-equipment-overview';
   SELECT * FROM quiz_attempts WHERE topic_id = 'ow-equipment-overview';
   ```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Quiz not rendering | Check `document.metadata?.quiz` exists; verify YAML frontmatter format |
| Prose styles not working | Install @tailwindcss/typography plugin; add to config |
| Quiz completion doesn't update progress | Check RLS policies on `user_progress` table; verify server action |
| Redirect loop after completion | Ensure `revalidatePath` is called; check redirect path is correct |
| "Mark as Complete" not showing | Verify `hasQuiz` is false and `isCompleted` is false |
| Quiz questions parse error | Validate YAML syntax in frontmatter; ensure correct indentation |
| Server action error | Check `'use server'` directive present; verify Supabase client in action |

## Files Modified

- [ ] ✅ Modified: `app/learn/[certification]/[topic]/page.tsx` (added quiz integration)
- [ ] ✅ Modified: `tailwind.config.js` (added typography plugin if needed)

## What Comes Next

**Next Substep:** 3.3.5 - Add Quiz Statistics Dashboard

Create a dashboard showing quiz performance, best scores, and historical attempts for each topic.
