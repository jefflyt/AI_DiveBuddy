# Step 3.3.5: Add Quiz Statistics Dashboard

**Part of:** PR 3.3 - Quiz System & Knowledge Validation  
**Focus:** Display quiz performance analytics and historical attempts  
**Files to Create:** `components/quiz/QuizStats.tsx`, update profile page  
**Estimated Time:** 15 minutes

## Overview

Build a statistics dashboard showing quiz performance, trends, best scores, and recent attempts. Display this on the user's profile page for motivation and progress tracking.

## Pre-Substep Checklist

- [ ] **Completed:** Step 3.3.4 - Quizzes integrated with topic pages
- [ ] **API ready:** `/api/quiz/stats/[topicId]` endpoint functional
- [ ] **Database:** Quiz attempts stored with historical data
- [ ] **Profile page:** Exists at `app/profile/page.tsx`

## Implementation

### Goal

Create visual components that display quiz statistics to help users track performance and identify areas for improvement.

### Step-by-Step Instructions

#### Step 1: Create Quiz Statistics Component

- [ ] Create `components/quiz/QuizStats.tsx`:

```typescript
'use client'

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { TrendingUp, Trophy, Target, Clock } from 'lucide-react'

interface QuizStatsProps {
  topicId: string
  topicTitle: string
  stats: {
    totalAttempts: number
    bestScore: number
    averageScore: number
    passedCount: number
    lastAttemptDate: string | null
  }
  recentAttempts?: Array<{
    id: string
    score: number
    passed: boolean
    completed_at: string
  }>
}

export function QuizStats({ topicId, topicTitle, stats, recentAttempts = [] }: QuizStatsProps) {
  const passRate = stats.totalAttempts > 0
    ? Math.round((stats.passedCount / stats.totalAttempts) * 100)
    : 0

  const improvement = recentAttempts.length >= 2
    ? recentAttempts[0].score - recentAttempts[recentAttempts.length - 1].score
    : 0

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle className="text-lg">{topicTitle}</CardTitle>
            <CardDescription className="text-xs">Quiz Performance</CardDescription>
          </div>
          {stats.passedCount > 0 && (
            <Badge variant="outline" className="bg-green-50 text-green-700">
              <Trophy className="w-3 h-3 mr-1" />
              Passed
            </Badge>
          )}
        </div>
      </CardHeader>

      <CardContent className="space-y-4">
        {/* Key Metrics */}
        <div className="grid grid-cols-2 gap-4">
          <div className="p-3 bg-blue-50 rounded-lg">
            <div className="flex items-center gap-2 text-blue-600 mb-1">
              <Trophy className="w-4 h-4" />
              <span className="text-xs font-medium">Best Score</span>
            </div>
            <p className="text-2xl font-bold text-blue-700">{stats.bestScore}%</p>
          </div>

          <div className="p-3 bg-purple-50 rounded-lg">
            <div className="flex items-center gap-2 text-purple-600 mb-1">
              <Target className="w-4 h-4" />
              <span className="text-xs font-medium">Average</span>
            </div>
            <p className="text-2xl font-bold text-purple-700">
              {Math.round(stats.averageScore)}%
            </p>
          </div>
        </div>

        {/* Pass Rate */}
        <div>
          <div className="flex justify-between text-sm mb-2">
            <span className="text-muted-foreground">Pass Rate</span>
            <span className="font-medium">{passRate}%</span>
          </div>
          <Progress value={passRate} className="h-2" />
          <p className="text-xs text-muted-foreground mt-1">
            {stats.passedCount} of {stats.totalAttempts} attempts passed
          </p>
        </div>

        {/* Improvement Indicator */}
        {improvement !== 0 && (
          <div className="flex items-center gap-2 text-sm">
            <TrendingUp
              className={`w-4 h-4 ${
                improvement > 0 ? 'text-green-600' : 'text-red-600'
              }`}
            />
            <span
              className={improvement > 0 ? 'text-green-700' : 'text-red-700'}
            >
              {improvement > 0 ? '+' : ''}
              {improvement}% from first attempt
            </span>
          </div>
        )}

        {/* Recent Attempts */}
        {recentAttempts.length > 0 && (
          <div>
            <h4 className="text-sm font-medium mb-2">Recent Attempts</h4>
            <div className="space-y-2">
              {recentAttempts.slice(0, 3).map((attempt) => (
                <div
                  key={attempt.id}
                  className="flex items-center justify-between text-sm p-2 bg-gray-50 rounded"
                >
                  <div className="flex items-center gap-2">
                    <Clock className="w-3 h-3 text-muted-foreground" />
                    <span className="text-xs text-muted-foreground">
                      {new Date(attempt.completed_at).toLocaleDateString()}
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="font-medium">{attempt.score}%</span>
                    <Badge
                      variant={attempt.passed ? 'default' : 'secondary'}
                      className="text-xs"
                    >
                      {attempt.passed ? 'Pass' : 'Fail'}
                    </Badge>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* No Attempts Yet */}
        {stats.totalAttempts === 0 && (
          <p className="text-sm text-center text-muted-foreground italic py-4">
            No quiz attempts yet. Complete the quiz to see your stats!
          </p>
        )}
      </CardContent>
    </Card>
  )
}
```

#### Step 2: Create Quiz History Page

- [ ] Create `app/learn/quiz-history/page.tsx`:

```typescript
import { createServerClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { QuizStats } from '@/components/quiz/QuizStats'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { ArrowLeft, TrendingUp } from 'lucide-react'
import Link from 'next/link'

async function getQuizStatistics(userId: string) {
  const supabase = createServerClient()

  // Get all unique topics the user has attempted
  const { data: topics, error: topicsError } = await supabase
    .from('quiz_attempts')
    .select('topic_id')
    .eq('user_id', userId)
    .order('completed_at', { ascending: false })

  if (topicsError) {
    console.error('Error fetching topics:', topicsError)
    return []
  }

  // Get unique topic IDs
  const uniqueTopics = [...new Set(topics.map((t) => t.topic_id))]

  // Fetch stats for each topic
  const statsPromises = uniqueTopics.map(async (topicId) => {
    // Get topic info
    const { data: doc } = await supabase
      .from('documents')
      .select('title, metadata')
      .eq('category', 'education')
      .eq('metadata->>id', topicId)
      .single()

    // Get stats
    const { data: stats } = await supabase.rpc('get_topic_quiz_stats', {
      p_user_id: userId,
      p_topic_id: topicId,
    })

    // Get recent attempts
    const { data: attempts } = await supabase
      .from('quiz_attempts')
      .select('id, score, passed, completed_at')
      .eq('user_id', userId)
      .eq('topic_id', topicId)
      .order('completed_at', { ascending: false })
      .limit(5)

    return {
      topicId,
      topicTitle: doc?.title || topicId,
      stats: stats?.[0] || {
        total_attempts: 0,
        best_score: 0,
        average_score: 0,
        passed_count: 0,
        last_attempt_date: null,
      },
      recentAttempts: attempts || [],
    }
  })

  return Promise.all(statsPromises)
}

export default async function QuizHistoryPage() {
  const supabase = createServerClient()

  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    redirect('/auth/login?redirect=/learn/quiz-history')
  }

  const quizStats = await getQuizStatistics(user.id)

  // Calculate overall stats
  const totalAttempts = quizStats.reduce((sum, s) => sum + s.stats.total_attempts, 0)
  const totalPassed = quizStats.reduce((sum, s) => sum + s.stats.passed_count, 0)
  const overallPassRate = totalAttempts > 0
    ? Math.round((totalPassed / totalAttempts) * 100)
    : 0

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="container mx-auto px-4 max-w-5xl">
        {/* Header */}
        <div className="mb-8">
          <Link
            href="/learn"
            className="inline-flex items-center text-sm text-muted-foreground hover:text-foreground mb-4"
          >
            <ArrowLeft className="w-4 h-4 mr-1" />
            Back to Learning
          </Link>

          <h1 className="text-3xl font-bold mb-2">Quiz Performance</h1>
          <p className="text-muted-foreground">
            Track your progress and identify areas for improvement
          </p>
        </div>

        {/* Overall Stats */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <TrendingUp className="w-5 h-5 text-blue-600" />
              Overall Statistics
            </CardTitle>
            <CardDescription>Your cumulative quiz performance</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-3 gap-4">
              <div className="text-center">
                <p className="text-3xl font-bold text-blue-600">{totalAttempts}</p>
                <p className="text-sm text-muted-foreground">Total Attempts</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold text-green-600">{totalPassed}</p>
                <p className="text-sm text-muted-foreground">Passed</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold text-purple-600">{overallPassRate}%</p>
                <p className="text-sm text-muted-foreground">Pass Rate</p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Individual Topic Stats */}
        <div className="space-y-4">
          <h2 className="text-xl font-semibold">Topics</h2>

          {quizStats.length === 0 ? (
            <Card>
              <CardContent className="py-12 text-center">
                <p className="text-muted-foreground">
                  No quiz attempts yet. Start learning to see your stats!
                </p>
              </CardContent>
            </Card>
          ) : (
            <div className="grid md:grid-cols-2 gap-4">
              {quizStats.map((stat) => (
                <QuizStats
                  key={stat.topicId}
                  topicId={stat.topicId}
                  topicTitle={stat.topicTitle}
                  stats={stat.stats}
                  recentAttempts={stat.recentAttempts}
                />
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
```

#### Step 3: Add Quiz History Link to Navigation

- [ ] Update `components/layout/Header.tsx`:

```typescript
<nav className="flex items-center gap-6">
  <Link href="/" className="text-sm font-medium">
    Home
  </Link>
  <Link href="/learn" className="text-sm font-medium">
    Learn
  </Link>
  <Link href="/learn/quiz-history" className="text-sm font-medium">
    My Progress
  </Link>
  <Link href="/chat" className="text-sm font-medium">
    Chat
  </Link>
  <Link href="/profile" className="text-sm font-medium">
    Profile
  </Link>
</nav>
```

## Verification Checklist

- [ ] Component created: `components/quiz/QuizStats.tsx`
- [ ] Page created: `app/learn/quiz-history/page.tsx`
- [ ] Navigation updated with "My Progress" link
- [ ] Stats display correctly for each topic
- [ ] Overall statistics calculate accurately
- [ ] Recent attempts show in chronological order
- [ ] Pass rate visual indicator works
- [ ] Improvement trend displays when applicable
- [ ] Empty state shows for topics with no attempts

## Testing

1. **View quiz history page:**
   ```
   http://localhost:3000/learn/quiz-history
   ```
   - Should show overall stats at top
   - Individual topic cards below

2. **Test with data:**
   - Complete several quizzes with varying scores
   - Check stats update correctly
   - Verify pass rate calculation

3. **Test empty state:**
   - View page with new user (no attempts)
   - Should show "No quiz attempts yet" message

4. **Test improvement indicator:**
   - Retake a quiz with better score
   - Should show positive improvement
   - Retake with worse score → should show negative

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Stats not loading | Check RPC function `get_topic_quiz_stats` exists in Supabase |
| Duplicate topics appearing | Verify `uniqueTopics` filter is working; check topic_id consistency |
| Pass rate calculation wrong | Verify `passedCount / totalAttempts` logic; check data types |
| Recent attempts not showing | Check query limit and order; verify `completed_at` sorting |
| Overall stats incorrect | Check reduce function aggregation; verify all topics included |
| Empty state not showing | Verify `quizStats.length === 0` condition; check data fetch |
| Navigation link not working | Ensure route path matches file location exactly |

## Files Modified

- [ ] ✅ Created: `components/quiz/QuizStats.tsx`
- [ ] ✅ Created: `app/learn/quiz-history/page.tsx`
- [ ] ✅ Modified: `components/layout/Header.tsx` (added My Progress link)

## What Comes Next

**Next Phase:** Phase 4 - Malaysia Dive Destinations

Begin building the destination database with detailed information about dive sites across Malaysia (East and West).
