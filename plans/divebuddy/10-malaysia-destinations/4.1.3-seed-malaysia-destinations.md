# Step 4.1.3: Seed Malaysia Destinations with Embeddings

**Part of:** PR 4.1 - Malaysia Dive Destination Database  
**Focus:** Create seed script to embed and store Malaysian destination data in Supabase  
**File to Create:** `scripts/seed-malaysia-destinations.ts`  
**Estimated Time:** 30-40 minutes

---

## Pre-Substep Checklist

- [ ] Step 4.1.2 completed (all destination markdown files created)
- [ ] Branch `4.1-malaysia-destinations` checked out
- [ ] Supabase project connected (`.env.local` configured)
- [ ] pgvector extension enabled in Supabase
- [ ] `diving_documents` table exists with vector column
- [ ] Embedding utilities exist (`lib/ai/embeddings.ts`, `lib/ai/chunking.ts`)

---

## Implementation

### Goal

Create and run a seed script that processes Malaysian destination markdown files, generates embeddings using Gemini's text-embedding-004 model, and stores them in Supabase for RAG retrieval by the trip planning agent.

### Step-by-Step Instructions

#### 1. Create Seed Script for Destinations

**File:** `scripts/seed-malaysia-destinations.ts`

```typescript
import { createClient } from '@supabase/supabase-js'
import { embed } from '../lib/ai/embeddings'
import { chunkMarkdown } from '../lib/ai/chunking'
import fs from 'fs'
import path from 'path'
import matter from 'gray-matter'

// Initialize Supabase admin client
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

if (!supabaseUrl || !supabaseServiceKey) {
  throw new Error('Missing Supabase environment variables')
}

const supabase = createClient(supabaseUrl, supabaseServiceKey)

interface DestinationMetadata {
  id: string
  name: string
  slug: string
  region: string
  country: string
  coordinates: { lat: number; lng: number }
  skillLevel: string
  depthRange: string
  visibility: string
  bestMonths: number[]
  marineLife: string[]
  highlights: string[]
  difficulty: string
}

interface DocumentChunk {
  content: string
  metadata: {
    source: string
    category: string
    destination_id: string
    destination_name: string
    region: string
    country: string
    chunk_index: number
    total_chunks: number
  }
}

async function processDestinationFile(filePath: string): Promise<DocumentChunk[]> {
  console.log(`üìÑ Processing: ${path.basename(filePath)}`)
  
  // Read markdown file
  const fileContent = fs.readFileSync(filePath, 'utf-8')
  
  // Parse frontmatter and content
  const { data: frontmatter, content } = matter(fileContent)
  const metadata = frontmatter as DestinationMetadata
  
  // Chunk the content (split long markdown into smaller pieces)
  const chunks = chunkMarkdown(content, {
    maxChunkSize: 1000, // ~1000 characters per chunk
    overlap: 100 // 100 character overlap between chunks
  })
  
  console.log(`  ‚Ü≥ Split into ${chunks.length} chunks`)
  
  // Create document chunks with metadata
  return chunks.map((chunk, index) => ({
    content: chunk,
    metadata: {
      source: `malaysia/${metadata.slug}`,
      category: 'destinations',
      destination_id: metadata.id,
      destination_name: metadata.name,
      region: metadata.region,
      country: metadata.country,
      chunk_index: index,
      total_chunks: chunks.length
    }
  }))
}

async function embedAndStoreChunk(chunk: DocumentChunk): Promise<void> {
  try {
    // Generate embedding for chunk content
    const embedding = await embed(chunk.content)
    
    // Store in Supabase
    const { error } = await supabase
      .from('diving_documents')
      .insert({
        content: chunk.content,
        embedding: embedding,
        metadata: chunk.metadata,
        category: 'destinations',
        created_at: new Date().toISOString()
      })
    
    if (error) {
      console.error(`  ‚ùå Error storing chunk:`, error)
      throw error
    }
    
    console.log(`  ‚úÖ Stored chunk ${chunk.metadata.chunk_index + 1}/${chunk.metadata.total_chunks}`)
  } catch (error) {
    console.error(`  ‚ùå Failed to embed/store chunk:`, error)
    throw error
  }
}

async function clearExistingDestinations(): Promise<void> {
  console.log('üóëÔ∏è  Clearing existing destination documents...')
  
  const { error } = await supabase
    .from('diving_documents')
    .delete()
    .eq('category', 'destinations')
  
  if (error) {
    console.error('Error clearing destinations:', error)
    throw error
  }
  
  console.log('‚úÖ Cleared existing destinations\n')
}

async function seedMalaysiaDestinations(): Promise<void> {
  console.log('üöÄ Starting Malaysia Destinations Seeding\n')
  console.log('=' .repeat(60))
  
  // Path to Malaysia destinations directory
  const destinationsDir = path.join(process.cwd(), 'data', 'destinations', 'malaysia')
  
  // Check if directory exists
  if (!fs.existsSync(destinationsDir)) {
    throw new Error(`Destinations directory not found: ${destinationsDir}`)
  }
  
  // Get all markdown files
  const files = fs.readdirSync(destinationsDir)
    .filter(file => file.endsWith('.md') && file !== 'README.md')
    .map(file => path.join(destinationsDir, file))
  
  console.log(`üìÅ Found ${files.length} destination files\n`)
  
  // Clear existing destination documents
  await clearExistingDestinations()
  
  let totalChunks = 0
  let processedFiles = 0
  
  // Process each destination file
  for (const file of files) {
    try {
      // Process file into chunks
      const chunks = await processDestinationFile(file)
      
      // Embed and store each chunk with delay to respect rate limits
      for (const chunk of chunks) {
        await embedAndStoreChunk(chunk)
        totalChunks++
        
        // Small delay to respect Gemini API rate limits (15 RPM on free tier)
        await new Promise(resolve => setTimeout(resolve, 250)) // 4 requests/second = safe
      }
      
      processedFiles++
      console.log(`‚úÖ Completed: ${path.basename(file)}\n`)
      
    } catch (error) {
      console.error(`‚ùå Failed to process ${path.basename(file)}:`, error)
      // Continue with other files even if one fails
    }
  }
  
  console.log('=' .repeat(60))
  console.log('üéâ Seeding Complete!')
  console.log(`üìä Summary:`)
  console.log(`   ‚Ä¢ Files processed: ${processedFiles}/${files.length}`)
  console.log(`   ‚Ä¢ Total chunks embedded: ${totalChunks}`)
  console.log(`   ‚Ä¢ Category: destinations`)
  console.log('=' .repeat(60))
}

// Run the seed script
seedMalaysiaDestinations()
  .then(() => {
    console.log('\n‚úÖ Script completed successfully')
    process.exit(0)
  })
  .catch((error) => {
    console.error('\n‚ùå Script failed:', error)
    process.exit(1)
  })
```

- [x] Create seed script for Malaysia destinations

#### 2. Update package.json with Seed Script

**File:** `package.json`

Add a script to run the seeder:

```json
{
  "scripts": {
    "seed:destinations": "tsx scripts/seed-malaysia-destinations.ts",
    "seed:malaysia": "tsx scripts/seed-malaysia-destinations.ts"
  }
}
```

- [x] Add seed script to package.json

#### 3. Install Required Dependencies (if not already installed)

```bash
npm install gray-matter
```

- [x] Ensure gray-matter installed (for parsing markdown frontmatter)

#### 4. Verify Environment Variables

**File:** `.env.local`

Ensure you have:

```bash
NEXT_PUBLIC_SUPABASE_URL=your_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
GOOGLE_API_KEY=your_gemini_api_key
```

**Note:** The service role key is needed for the seed script to bypass Row Level Security policies.

- [x] Verify environment variables configured

#### 5. Run the Seed Script

```bash
npm run seed:malaysia
```

**Expected Output:**

```
üöÄ Starting Malaysia Destinations Seeding

============================================================
üìÅ Found 20 destination files

üóëÔ∏è  Clearing existing destination documents...
‚úÖ Cleared existing destinations

üìÑ Processing: sipadan.md
  ‚Ü≥ Split into 8 chunks
  ‚úÖ Stored chunk 1/8
  ‚úÖ Stored chunk 2/8
  ...
  ‚úÖ Stored chunk 8/8
‚úÖ Completed: sipadan.md

üìÑ Processing: mabul.md
  ‚Ü≥ Split into 6 chunks
  ‚úÖ Stored chunk 1/6
  ...

[... continues for all files ...]

============================================================
üéâ Seeding Complete!
üìä Summary:
   ‚Ä¢ Files processed: 20/20
   ‚Ä¢ Total chunks embedded: 156
   ‚Ä¢ Category: destinations
============================================================

‚úÖ Script completed successfully
```

- [x] Run seed script successfully

#### 6. Verify Data in Supabase

**In Supabase Dashboard:**

1. Go to **Table Editor** ‚Üí `diving_documents`
2. Filter by `category = 'destinations'`
3. Verify you see ~150+ rows (depending on total chunks)
4. Check a few rows to confirm:
   - `content` field has destination text
   - `embedding` field has vector data (array of 768 numbers)
   - `metadata` includes destination_name, region, etc.

**SQL Query to Check:**

```sql
SELECT 
  count(*) as total_chunks,
  metadata->>'destination_name' as destination,
  metadata->>'region' as region
FROM diving_documents
WHERE category = 'destinations'
GROUP BY destination, region
ORDER BY destination;
```

Expected result: List of all destinations with chunk counts

- [x] Verify data stored correctly in Supabase

#### 7. Test Vector Search

Create a test script to verify embeddings work:

**File:** `scripts/test-destination-search.ts`

```typescript
import { createClient } from '@supabase/supabase-js'
import { embed } from '../lib/ai/embeddings'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

async function testSearch(query: string) {
  console.log(`\nüîç Searching for: "${query}"`)
  console.log('=' .repeat(60))
  
  // Generate embedding for query
  const queryEmbedding = await embed(query)
  
  // Search for similar destination content
  const { data, error } = await supabase.rpc('match_documents', {
    query_embedding: queryEmbedding,
    match_threshold: 0.7,
    match_count: 5,
    filter: { category: 'destinations' }
  })
  
  if (error) {
    console.error('Search error:', error)
    return
  }
  
  console.log(`üìä Found ${data.length} results:\n`)
  
  data.forEach((result: any, index: number) => {
    console.log(`${index + 1}. ${result.metadata.destination_name} (${result.metadata.region})`)
    console.log(`   Similarity: ${(result.similarity * 100).toFixed(1)}%`)
    console.log(`   Preview: ${result.content.substring(0, 150)}...`)
    console.log()
  })
}

async function runTests() {
  await testSearch("Where can I see turtles in Malaysia?")
  await testSearch("Best muck diving and macro photography")
  await testSearch("Beginner-friendly dive sites near Kuala Lumpur")
  await testSearch("Hammerhead shark diving")
}

runTests()
  .then(() => process.exit(0))
  .catch(error => {
    console.error('Test failed:', error)
    process.exit(1)
  })
```

Run the test:

```bash
npx tsx scripts/test-destination-search.ts
```

**Expected Output:**

```
üîç Searching for: "Where can I see turtles in Malaysia?"
============================================================
üìä Found 5 results:

1. Sipadan Island (Sabah, East Malaysia)
   Similarity: 92.3%
   Preview: Sipadan is renowned for its resident population of green and hawksbill turtles. It's common to see 10-20 turtles on a single dive...

2. Pulau Tioman (Pahang, West Malaysia)
   Similarity: 84.1%
   Preview: Green and hawksbill turtles are frequently spotted at Chebeh Island and Tiger Reef...

[... etc ...]
```

- [x] Test vector search functionality

---

## Verification Checklist

### Data Integrity
- [ ] All 20+ Malaysian destinations processed without errors
- [ ] Each destination split into appropriate chunk sizes (< 1000 chars)
- [ ] Total chunks in database matches expected count (~150-200)
- [ ] Embeddings generated for all chunks (no null vectors)
- [ ] Metadata includes required fields (destination_id, name, region, country)

### Functionality
- [ ] Vector search returns relevant results
- [ ] Similarity scores are reasonable (>0.7 for good matches)
- [ ] Search queries match correct destinations:
  - "turtles" ‚Üí Sipadan, Tioman
  - "muck diving" ‚Üí Mabul
  - "beginner" ‚Üí Perhentian, Tioman, Redang
  - "hammerhead sharks" ‚Üí Layang-Layang

### Performance
- [ ] Seed script completes in reasonable time (< 10 minutes)
- [ ] No rate limit errors from Gemini API (if errors, increase delay)
- [ ] Vector search queries return in < 500ms

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| **Rate limit errors** | Increase delay between embedding requests in seed script (change 250ms to 500ms or more) |
| **Missing SUPABASE_SERVICE_ROLE_KEY** | Get service role key from Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí service_role key (keep secret!) |
| **Embedding dimension mismatch** | Ensure pgvector column is `vector(768)` for text-embedding-004 |
| **No results from vector search** | Verify `match_documents` RPC function exists and uses correct similarity function |
| **Chunks too large** | Reduce `maxChunkSize` in seed script (try 800 instead of 1000) |
| **Frontmatter parse errors** | Check markdown files have valid YAML frontmatter between `---` markers |
| **Gray-matter not found** | Run `npm install gray-matter` |
| **Search returns wrong destinations** | Check embedding quality - may need to adjust chunking strategy or improve content |

---

## Files Modified

### Created
- `scripts/seed-malaysia-destinations.ts` - Main seeding script
- `scripts/test-destination-search.ts` - Vector search test script

### Modified
- `package.json` - Added seed:destinations script

### Database
- `diving_documents` table - Populated with ~150-200 destination chunks
- Each chunk has vector embedding (768 dimensions)
- Metadata includes destination info for filtering

---

## What Comes Next

**Next Step:** 4.2.1 - Create Destination Browser Page UI

With all Malaysian destination content embedded in Supabase, the next substep will build the frontend UI for browsing and filtering destinations. This will include:

- Destination browser page (`/destinations`)
- Destination cards with filters
- Individual destination detail pages
- Search and filter functionality

---

**Time Estimate:** 30-40 minutes (script creation and execution)

**Ready to proceed?** Run the seed script and verify vector search is working with Malaysian destination content.
